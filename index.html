<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Restaurant POS</title>
    <style>
        /* ... KEEP ALL THE PREVIOUS CSS STYLES ... */
        /* They remain exactly the same as your previous code */
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üçΩÔ∏è Restaurant POS</h1>
        <div class="header-buttons">
            <a href="kitchen.html" class="btn btn-outline">üë®‚Äçüç≥ Kitchen</a>
            <button class="btn btn-outline" onclick="toggleOrderPanel()" id="order-toggle">üìã Order</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tables Sidebar -->
        <div class="tables-sidebar">
            <h3>Tables</h3>
            <div class="tables-grid" id="tables-list">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>Loading tables...</div>
                </div>
            </div>
        </div>

        <!-- Menu Area -->
        <div class="menu-area">
            <h3>Menu Items</h3>
            <div class="category-tabs" id="category-tabs">
                <div class="category-tab active" data-category="all">All</div>
            </div>
            <div class="menu-grid" id="menu-grid">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <div>Loading menu...</div>
                </div>
            </div>
        </div>

        <!-- Order Panel -->
        <div class="order-panel" id="order-panel">
            <div class="order-header">
                <h3 id="current-table-title">Select a Table</h3>
                <button class="btn btn-outline" onclick="toggleOrderPanel()" style="margin-top: 8px; padding: 4px 8px; font-size: 0.8rem;">
                    Close
                </button>
            </div>
            <div class="order-body" id="order-items">
                <div style="color: #64748b; text-align: center; padding: 40px 20px;">
                    No items added
                </div>
            </div>
            <div class="order-footer">
                <div class="order-total">
                    Total: <span id="order-total">$0.00</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="submitOrder()">Submit Order</button>
                    <button class="btn btn-success" onclick="showCheckoutModal()" id="checkout-btn" style="display: none;">Checkout</button>
                    <button class="btn btn-secondary" onclick="clearOrder()">Clear Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Swipe Indicator -->
    <div class="swipe-indicator">
        ‚Üë Swipe up to view order
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="#" class="mobile-nav-item active" onclick="showSection('tables')">
            <div class="icon">ü™ë</div>
            <div>Tables</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showSection('menu')">
            <div class="icon">üìã</div>
            <div>Menu</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="toggleOrderPanel()">
            <div class="icon">üõí</div>
            <div>Order</div>
        </a>
        <a href="kitchen.html" class="mobile-nav-item">
            <div class="icon">üë®‚Äçüç≥</div>
            <div>Kitchen</div>
        </a>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div id="sync-status" class="sync-status online">üü¢ Synced</div>
        <div id="last-update">Last update: Just now</div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkout-modal">
        <div class="modal">
            <h2>Checkout - Table <span id="checkout-table-number"></span></h2>
            <div id="checkout-items-list"></div>
            <div class="order-total" style="margin: 15px 0;">
                Total: <span id="checkout-total">$0.00</span>
            </div>
            
            <h4 style="margin-bottom: 10px;">Payment Method</h4>
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPayment('cash')">
                    <div style="font-size: 1.5rem;">üíµ</div>
                    <div>Cash</div>
                </div>
                <div class="payment-method" onclick="selectPayment('card')">
                    <div style="font-size: 1.5rem;">üí≥</div>
                    <div>Card</div>
                </div>
                <div class="payment-method" onclick="selectPayment('upi')">
                    <div style="font-size: 1.5rem;">üì±</div>
                    <div>UPI</div>
                </div>
                <div class="payment-method" onclick="selectPayment('split')">
                    <div style="font-size: 1.5rem;">‚ÜîÔ∏è</div>
                    <div>Split</div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 15px;">
                <button class="btn btn-success" onclick="processCheckout()">Complete Payment</button>
                <button class="btn btn-secondary" onclick="hideModal('checkout-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notification-container"></div>

    <!-- Add loading spinner style -->
    <style>
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .loading-spinner .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        // ==================== CONFIGURATION ====================
        const APP_NAME = 'RestaurantPOS';
        const STORAGE_KEYS = {
            SERVER: APP_NAME + '_server_data',
            DEVICE: APP_NAME + '_device_id'
        };
        
        const SYNC_INTERVAL = 2000; // 2 seconds
        let syncInterval;

        // ==================== STATE MANAGEMENT ====================
        const state = {
            deviceId: '',
            serverData: null,
            currentTable: null,
            currentOrder: [],
            selectedPayment: null,
            lastSync: null
        };

        // ==================== INITIALIZATION ====================
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initializeApp();
            setupTouchEvents();
        });

        function initializeApp() {
            console.log('Initializing app...');
            
            // Generate or get device ID
            state.deviceId = getDeviceId();
            console.log('Device ID:', state.deviceId);
            
            // Load initial data
            loadData();
            
            // Start sync loop
            startSyncLoop();
            
            // Setup event listeners
            setupEventListeners();
            
            console.log('App initialized successfully');
        }

        function getDeviceId() {
            let deviceId = localStorage.getItem(STORAGE_KEYS.DEVICE);
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(STORAGE_KEYS.DEVICE, deviceId);
            }
            return deviceId;
        }

        // ==================== DATA MANAGEMENT ====================
        function loadData() {
            console.log('Loading data...');
            const saved = localStorage.getItem(STORAGE_KEYS.SERVER);
            
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    console.log('Found saved data:', parsed);
                    
                    // Check if data structure is valid
                    if (!parsed.tables || !parsed.menu) {
                        console.log('Invalid data structure, creating demo data...');
                        createDemoData();
                    } else {
                        // Merge with existing state to preserve current session
                        if (state.serverData && state.currentTable && state.currentOrder.length > 0) {
                            const tableIndex = parsed.tables.findIndex(t => t.id === state.currentTable);
                            if (tableIndex !== -1) {
                                parsed.tables[tableIndex].currentOrder = [...state.currentOrder];
                            }
                        }
                        
                        state.serverData = parsed;
                        state.lastSync = new Date().toISOString();
                        console.log('Data loaded successfully');
                    }
                    
                } catch (e) {
                    console.error('Error loading data:', e);
                    createDemoData();
                }
            } else {
                console.log('No saved data found, creating demo data...');
                createDemoData();
            }
            
            // Render immediately
            renderAll();
        }

        function createDemoData() {
            console.log('Creating demo data...');
            
            // Create demo tables (1-8)
            const tables = [];
            for (let i = 1; i <= 8; i++) {
                tables.push({
                    id: `table_${i}`,
                    number: i,
                    name: `Table ${i}`,
                    capacity: i <= 2 ? 2 : i <= 5 ? 4 : 6,
                    status: 'vacant',
                    currentOrder: [],
                    lastUpdate: new Date().toISOString()
                });
            }

            // Create demo menu
            const menu = [
                { id: 'item_1', name: 'Burger', category: 'Main', price: 8.99, stock: 50 },
                { id: 'item_2', name: 'Pizza', category: 'Main', price: 12.99, stock: 50 },
                { id: 'item_3', name: 'Fries', category: 'Side', price: 4.99, stock: 50 },
                { id: 'item_4', name: 'Salad', category: 'Side', price: 6.99, stock: 50 },
                { id: 'item_5', name: 'Coke', category: 'Drink', price: 1.99, stock: 50 },
                { id: 'item_6', name: 'Water', category: 'Drink', price: 0.99, stock: 50 },
                { id: 'item_7', name: 'Ice Cream', category: 'Dessert', price: 4.99, stock: 50 },
                { id: 'item_8', name: 'Coffee', category: 'Drink', price: 2.49, stock: 50 }
            ];

            state.serverData = {
                tables: tables,
                menu: menu,
                orders: [],
                transactions: [],
                lastUpdate: new Date().toISOString()
            };
            
            state.lastSync = new Date().toISOString();
            
            // Save demo data
            saveData();
            console.log('Demo data created successfully');
        }

        function saveData() {
            if (!state.serverData) {
                console.error('No data to save');
                return;
            }
            
            // Update timestamp
            state.serverData.lastUpdate = new Date().toISOString();
            
            // Save to localStorage
            localStorage.setItem(STORAGE_KEYS.SERVER, JSON.stringify(state.serverData));
            console.log('Data saved to localStorage');
            
            // Trigger sync for other tabs
            try {
                window.dispatchEvent(new StorageEvent('storage', {
                    key: STORAGE_KEYS.SERVER,
                    newValue: JSON.stringify(state.serverData)
                }));
            } catch (e) {
                console.log('Storage event dispatch failed:', e);
            }
            
            updateSyncStatus();
        }

        // ==================== SYNC SYSTEM ====================
        function startSyncLoop() {
            // Clear any existing interval
            if (syncInterval) clearInterval(syncInterval);
            
            // Check for updates every SYNC_INTERVAL
            syncInterval = setInterval(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.SERVER);
                if (saved) {
                    try {
                        const newData = JSON.parse(saved);
                        // Only update if server data is newer
                        if (!state.serverData || !state.serverData.lastUpdate || 
                            new Date(newData.lastUpdate) > new Date(state.serverData.lastUpdate)) {
                            
                            const oldOrderCount = state.serverData ? state.serverData.orders.length : 0;
                            state.serverData = newData;
                            state.lastSync = new Date().toISOString();
                            
                            // Update UI
                            renderAll();
                            
                            // If we have a current table, update its data
                            if (state.currentTable) {
                                const table = state.serverData.tables.find(t => t.id === state.currentTable);
                                if (table) {
                                    state.currentOrder = table.currentOrder || [];
                                    updateOrderPanel();
                                }
                            }
                            
                            if (newData.orders.length > oldOrderCount) {
                                console.log('New orders detected');
                            }
                        }
                    } catch (e) {
                        console.error('Error syncing from server:', e);
                    }
                }
            }, SYNC_INTERVAL);
            
            console.log('Sync loop started');
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Listen for changes from other tabs
            window.addEventListener('storage', (e) => {
                console.log('Storage event detected:', e.key);
                if (e.key === STORAGE_KEYS.SERVER) {
                    try {
                        const newData = JSON.parse(e.newValue);
                        if (newData && state.serverData) {
                            // Check if data actually changed
                            if (JSON.stringify(newData) !== JSON.stringify(state.serverData)) {
                                state.serverData = newData;
                                state.lastSync = new Date().toISOString();
                                renderAll();
                                showNotification('Data updated from another device', 'info');
                                console.log('Data synced from another tab');
                            }
                        }
                    } catch (e) {
                        console.error('Error processing storage event:', e);
                    }
                }
            });
            
            // Listen for online/offline status
            window.addEventListener('online', () => {
                document.getElementById('sync-status').className = 'sync-status online';
                document.getElementById('sync-status').textContent = 'üü¢ Online';
                console.log('Device is online');
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('sync-status').className = 'sync-status offline';
                document.getElementById('sync-status').textContent = 'üî¥ Offline';
                console.log('Device is offline');
            });

            // Prevent pull-to-refresh on mobile
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            console.log('Event listeners set up');
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderAll() {
            console.log('Rendering all components...');
            renderTables();
            renderCategories();
            renderMenu();
            updateOrderPanel();
            updateSyncStatus();
        }

        function renderTables() {
            const container = document.getElementById('tables-list');
            if (!container) {
                console.error('Tables container not found');
                return;
            }
            
            if (!state.serverData || !state.serverData.tables) {
                console.log('No table data available');
                container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Loading tables...</div></div>';
                return;
            }
            
            const tables = state.serverData.tables || [];
            console.log(`Rendering ${tables.length} tables`);
            
            container.innerHTML = tables.map(table => {
                const orderTotal = (table.currentOrder || []).reduce((sum, item) => 
                    sum + (item.price * item.quantity), 0);
                
                return `
                    <div class="table-card ${table.status} ${state.currentTable === table.id ? 'active' : ''}" 
                         onclick="selectTable('${table.id}')">
                        <div class="table-number">${table.number}</div>
                        <div class="table-status">${table.status}</div>
                        ${orderTotal > 0 ? 
                            `<div class="table-amount">$${orderTotal.toFixed(2)}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            console.log('Tables rendered successfully');
        }

        function renderCategories() {
            const container = document.getElementById('category-tabs');
            if (!container) {
                console.error('Category tabs container not found');
                return;
            }
            
            if (!state.serverData || !state.serverData.menu) {
                return;
            }
            
            const categories = ['all', ...new Set(state.serverData.menu.map(item => item.category))];
            
            container.innerHTML = categories.map(category => `
                <div class="category-tab ${category === 'all' ? 'active' : ''}" 
                     onclick="filterMenu('${category}')">
                    ${category === 'all' ? 'All' : category}
                </div>
            `).join('');
            
            console.log(`Rendered ${categories.length} categories`);
        }

        function renderMenu(filter = 'all') {
            const container = document.getElementById('menu-grid');
            if (!container) {
                console.error('Menu container not found');
                return;
            }
            
            if (!state.serverData || !state.serverData.menu) {
                console.log('No menu data available');
                container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div>Loading menu...</div></div>';
                return;
            }
            
            let items = state.serverData.menu || [];
            if (filter !== 'all') {
                items = items.filter(item => item.category === filter);
            }
            
            console.log(`Rendering ${items.length} menu items`);
            
            container.innerHTML = items.map(item => {
                const currentQty = getOrderQuantity(item.id);
                return `
                    <div class="menu-item" onclick="quickAdd('${item.id}')">
                        <h4>${item.name}</h4>
                        <div class="menu-item-category">${item.category}</div>
                        <div class="menu-item-price">$${item.price.toFixed(2)}</div>
                        <div class="menu-item-controls">
                            <button class="qty-btn" onclick="adjustQuantity('${item.id}', -1, event)">-</button>
                            <div class="qty-display">${currentQty}</div>
                            <button class="qty-btn" onclick="adjustQuantity('${item.id}', 1, event)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Menu rendered successfully');
        }

        function filterMenu(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter menu
            renderMenu(category);
        }

        function updateOrderPanel() {
            const itemsContainer = document.getElementById('order-items');
            const totalElement = document.getElementById('order-total');
            const tableTitle = document.getElementById('current-table-title');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (state.currentTable && state.serverData) {
                const table = state.serverData.tables.find(t => t.id === state.currentTable);
                if (table) {
                    tableTitle.textContent = `Table ${table.number}`;
                    checkoutBtn.style.display = table.status === 'occupied' ? 'block' : 'none';
                }
            } else {
                tableTitle.textContent = 'Select a Table';
                checkoutBtn.style.display = 'none';
            }

            if (state.currentOrder.length === 0) {
                itemsContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 40px 20px;">No items added</div>';
                totalElement.textContent = '$0.00';
                return;
            }

            itemsContainer.innerHTML = state.currentOrder.map(item => `
                <div class="order-item">
                    <div class="order-item-name">${item.name}</div>
                    <div class="order-item-qty">x${item.quantity}</div>
                    <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');

            const total = state.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        // ==================== ORDER MANAGEMENT ====================
        function selectTable(tableId) {
            if (!state.serverData) {
                showNotification('Please wait for data to load', 'error');
                return;
            }
            
            const table = state.serverData.tables.find(t => t.id === tableId);
            if (!table) {
                showNotification('Table not found', 'error');
                return;
            }
            
            state.currentTable = tableId;
            state.currentOrder = table.currentOrder || [];
            
            console.log(`Selected table ${table.number}`);
            
            // Open order panel on mobile
            if (window.innerWidth <= 1024) {
                toggleOrderPanel();
            }
            
            renderTables();
            updateOrderPanel();
            renderMenu();
            
            // Add haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function quickAdd(itemId) {
            if (!state.currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            adjustQuantity(itemId, 1);
        }

        function adjustQuantity(itemId, change, event = null) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!state.currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }

            if (!state.serverData) {
                showNotification('Data not loaded yet', 'error');
                return;
            }
            
            const menuItem = state.serverData.menu.find(item => item.id === itemId);
            if (!menuItem) {
                showNotification('Menu item not found', 'error');
                return;
            }

            let orderItem = state.currentOrder.find(item => item.id === itemId);

            if (orderItem) {
                orderItem.quantity += change;
                if (orderItem.quantity <= 0) {
                    state.currentOrder = state.currentOrder.filter(item => item.id !== itemId);
                }
            } else if (change > 0) {
                state.currentOrder.push({
                    id: itemId,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1
                });
            }

            // Update table in server data
            if (state.serverData && state.currentTable) {
                const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
                if (tableIndex !== -1) {
                    state.serverData.tables[tableIndex].currentOrder = [...state.currentOrder];
                    state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();
                    saveData();
                }
            }

            updateOrderPanel();
            renderMenu();
            
            // Quick haptic feedback
            if ('vibrate' in navigator) {
                navigator.vibrate(20);
            }
        }

        function getOrderQuantity(itemId) {
            const item = state.currentOrder.find(item => item.id === itemId);
            return item ? item.quantity : 0;
        }

        function submitOrder() {
            if (!state.currentTable || !state.serverData) {
                showNotification('Please select a table', 'error');
                return;
            }

            if (state.currentOrder.length === 0) {
                showNotification('Please add items to order', 'error');
                return;
            }

            const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
            if (tableIndex === -1) {
                showNotification('Table not found', 'error');
                return;
            }

            // Update table
            state.serverData.tables[tableIndex].status = 'occupied';
            state.serverData.tables[tableIndex].currentOrder = [...state.currentOrder];
            state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();

            // Create kitchen order
            const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            state.serverData.orders.push({
                id: orderId,
                tableId: state.currentTable,
                tableNumber: state.serverData.tables[tableIndex].number,
                items: [...state.currentOrder],
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: state.deviceId
            });

            // Save data
            saveData();
            
            // Clear current order
            state.currentOrder = [];
            
            // Update UI
            renderTables();
            updateOrderPanel();
            renderMenu();
            
            // Show success message
            showNotification('Order sent to kitchen!', 'success');
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate([50, 30, 50]);
            }
            
            console.log('Order submitted:', orderId);
        }

        // ==================== CHECKOUT SYSTEM ====================
        function showCheckoutModal() {
            if (!state.currentTable || !state.serverData) {
                showNotification('No table selected', 'error');
                return;
            }
            
            const table = state.serverData.tables.find(t => t.id === state.currentTable);
            if (!table || table.status !== 'occupied') {
                showNotification('Table is not occupied', 'error');
                return;
            }
            
            const items = table.currentOrder || [];
            if (items.length === 0) {
                showNotification('No items to checkout', 'error');
                return;
            }
            
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('checkout-table-number').textContent = table.number;
            document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
            
            const itemsList = document.getElementById('checkout-items-list');
            itemsList.innerHTML = items.map(item => `
                <div class="order-item">
                    <div class="order-item-name">${item.name}</div>
                    <div class="order-item-qty">x${item.quantity}</div>
                    <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');
            
            // Reset selected payment
            state.selectedPayment = null;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
            
            showModal('checkout-modal');
        }

        function selectPayment(method) {
            state.selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
            event.target.closest('.payment-method').classList.add('active');
        }

        function processCheckout() {
            if (!state.selectedPayment) {
                showNotification('Please select payment method', 'error');
                return;
            }

            if (!state.currentTable || !state.serverData) {
                showNotification('Checkout failed', 'error');
                return;
            }

            const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
            if (tableIndex === -1) {
                showNotification('Table not found', 'error');
                return;
            }
            
            const table = state.serverData.tables[tableIndex];
            const items = table.currentOrder || [];
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Create transaction
            state.serverData.transactions.push({
                id: `txn_${Date.now()}`,
                tableId: state.currentTable,
                tableNumber: table.number,
                items: items,
                total: total,
                paymentMethod: state.selectedPayment,
                status: 'completed',
                timestamp: new Date().toISOString(),
                processedBy: state.deviceId
            });
            
            // Update table
            state.serverData.tables[tableIndex].status = 'vacant';
            state.serverData.tables[tableIndex].currentOrder = [];
            state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();
            
            // Remove kitchen orders for this table
            state.serverData.orders = state.serverData.orders.filter(order => 
                order.tableId !== state.currentTable || order.status === 'completed'
            );
            
            // Save data
            saveData();
            
            // Reset UI
            state.currentOrder = [];
            state.selectedPayment = null;
            hideModal('checkout-modal');
            updateOrderPanel();
            renderTables();
            
            // Show success
            showNotification(`Payment of $${total.toFixed(2)} completed!`, 'success');
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        function clearOrder() {
            if (state.currentOrder.length === 0) {
                showNotification('No items to clear', 'info');
                return;
            }
            
            if (!confirm('Clear current order?')) return;
            
            state.currentOrder = [];
            
            // Update table in server data
            if (state.serverData && state.currentTable) {
                const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
                if (tableIndex !== -1) {
                    state.serverData.tables[tableIndex].currentOrder = [];
                    state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();
                    saveData();
                }
            }
            
            updateOrderPanel();
            renderMenu();
            showNotification('Order cleared', 'info');
        }

        // ==================== MOBILE UI FUNCTIONS ====================
        function toggleOrderPanel() {
            const panel = document.getElementById('order-panel');
            const toggleBtn = document.getElementById('order-toggle');
            
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                toggleBtn.textContent = 'üìã Close';
                // Update order items when opening
                updateOrderPanel();
            } else {
                toggleBtn.textContent = 'üìã Order';
            }
        }

        function showSection(section) {
            // Update active nav item
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.mobile-nav-item').classList.add('active');
            
            // Scroll to appropriate section
            if (section === 'tables') {
                document.querySelector('.tables-sidebar').scrollIntoView({ behavior: 'smooth' });
            } else if (section === 'menu') {
                document.querySelector('.menu-area').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function setupTouchEvents() {
            let startY;
            const panel = document.getElementById('order-panel');
            
            // Swipe up to open order panel
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (!startY) return;
                
                const currentY = e.touches[0].clientY;
                const diff = startY - currentY;
                
                // Swipe up from bottom
                if (diff > 50 && window.innerHeight - startY < 100) {
                    panel.classList.add('active');
                }
                
                // Swipe down to close
                if (diff < -50 && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            }, { passive: true });
            
            document.addEventListener('touchend', () => {
                startY = null;
            }, { passive: true });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Restore body scroll
            document.body.style.overflow = '';
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateSyncStatus() {
            const statusEl = document.getElementById('sync-status');
            const updateEl = document.getElementById('last-update');
            
            if (navigator.onLine) {
                statusEl.className = 'sync-status online';
                statusEl.textContent = 'üü¢ Online';
            } else {
                statusEl.className = 'sync-status offline';
                statusEl.textContent = 'üî¥ Offline';
            }
            
            if (state.lastSync) {
                const date = new Date(state.lastSync);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 5) {
                    updateEl.textContent = 'Last update: Just now';
                } else if (diff < 60) {
                    updateEl.textContent = `Last update: ${diff} sec ago`;
                } else {
                    updateEl.textContent = `Last update: ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
            }
        }

        // ==================== DEBUG FUNCTIONS ====================
        function debugData() {
            console.log('=== DEBUG DATA ===');
            console.log('State:', state);
            console.log('LocalStorage:', localStorage.getItem(STORAGE_KEYS.SERVER));
            console.log('Device ID:', state.deviceId);
            console.log('==================');
        }

        // ==================== PWA SUPPORT ====================
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after delay
            setTimeout(() => {
                if (deferredPrompt && confirm('Install this app for better experience?')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => {
                        deferredPrompt = null;
                    });
                }
            }, 10000);
        });

        // Auto-save before page unload
        window.addEventListener('beforeunload', () => {
            if (state.serverData) {
                saveData();
            }
        });

        // Force initial render after a short delay to ensure DOM is ready
        setTimeout(() => {
            if (!state.serverData) {
                console.log('Forcing data load after timeout...');
                loadData();
            }
        }, 500);
    </script>
</body>
</html>
