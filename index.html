<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }

        /* Setup Wizard */
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .setup-wizard.hidden {
            display: none;
        }

        .wizard-content {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .wizard-subtitle {
            color: #6b7280;
            text-align: center;
            margin-bottom: 2rem;
        }

        .setup-step {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .setup-step h3 {
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-number {
            background: #ea580c;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .setup-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .setup-option:hover {
            border-color: #ea580c;
            background: #ffedd5;
        }

        .setup-option input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #ea580c;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            background-color: #ea580c;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 1.125rem;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #c2410c;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            background-color: #16a34a;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-success:hover {
            background-color: #15803d;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-warning {
            background-color: #f59e0b;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .info-box code {
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #dc2626;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 64px;
            height: 64px;
            border: 4px solid #f3f4f6;
            border-top-color: #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation */
        .nav-bar {
            background-color: #ea580c;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background-color: #c2410c;
        }

        .nav-btn.active {
            background-color: #000;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sync-badge {
            background: #dcfce7;
            color: #166534;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .sync-badge.offline {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #ea580c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Action Header */
        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .table-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-card.occupied {
            background-color: #fee2e2;
            border-color: #ef4444;
        }

        .table-card.selected {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        .table-card.reserved {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }

        .table-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .table-status {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        .table-capacity {
            font-size: 0.75rem;
            color: #374151;
            margin-top: 0.25rem;
        }

        .table-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
        }

        /* Menu */
        .menu-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .category-section {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background: white;
            position: relative;
        }

        .category-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .menu-item:hover {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        .menu-item-actions {
            display: flex;
            gap: 0.25rem;
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
        }

        /* Order Summary */
        .order-summary {
            position: fixed;
            right: 1rem;
            top: 5rem;
            width: 320px;
            background: white;
            border: 2px solid #ea580c;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            max-height: calc(100vh - 6rem);
            overflow-y: auto;
        }

        .order-summary h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            gap: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ea580c;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            color: #ea580c;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .qty-btn:hover {
            background: #ea580c;
            color: white;
        }

        .order-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #111827;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .btn-submit {
            width: 100%;
            background: #16a34a;
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn-submit:hover {
            background: #15803d;
        }

        .btn-cancel {
            width: 100%;
            background: #dc2626;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        /* Kitchen Orders */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .kitchen-order {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
        }

        .kitchen-order.pending {
            border-color: #f59e0b;
            background-color: #fef3c7;
        }

        .kitchen-order.ready {
            border-color: #16a34a;
            background-color: #dcfce7;
        }

        .kitchen-order-header {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .kitchen-order-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Checkout */
        .checkout-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-btn {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .payment-btn.selected {
            border-color: #ea580c;
            background-color: #ffedd5;
        }

        .checkout-table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .checkout-table-card:hover {
            border-color: #ea580c;
            background: #ffedd5;
        }

        /* Expenses */
        .expense-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        /* Reports */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            margin: 1rem 0;
        }

        .stat-label {
            color: #6b7280;
            text-align: center;
            font-size: 0.875rem;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .date-picker {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        /* Management Grid */
        .management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .management-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
        }

        .management-card h3 {
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .order-summary {
                position: static;
                width: 100%;
                margin-top: 2rem;
            }

            .menu-categories {
                grid-template-columns: 1fr;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }

            .management-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                width: 100%;
            }

            .nav-btn span:last-child {
                display: none;
            }

            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .section-title {
                font-size: 1.25rem;
            }

            .wizard-content {
                padding: 2rem 1.5rem;
            }

            .date-picker {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Setup Wizard -->
    <div id="setup-wizard" class="setup-wizard hidden">
        <div class="wizard-content">
            <h1 class="wizard-title">üçΩÔ∏è Restaurant POS Setup</h1>
            <p class="wizard-subtitle">Configure your POS system</p>

            <div class="setup-step">
                <h3><span class="step-number">1</span> Choose Sync Method</h3>
                <div class="setup-option" onclick="selectSyncMethod('firebase')">
                    <input type="radio" name="sync" id="sync-firebase" checked>
                    <label for="sync-firebase">
                        <strong>Firebase Sync (Recommended)</strong><br>
                        <small>Real-time sync across all devices</small>
                    </label>
                </div>
            </div>

            <div id="firebase-setup" class="setup-step">
                <h3><span class="step-number">2</span> Restaurant Info</h3>
                
                <div class="input-group">
                    <label for="restaurant-name">Restaurant Name:</label>
                    <input type="text" id="restaurant-name" class="input-field" placeholder="My Restaurant">
                </div>

                <div class="input-group">
                    <label for="table-count">Number of Tables:</label>
                    <input type="number" id="table-count" class="input-field" min="1" max="50" value="10">
                </div>

                <div class="info-box">
                    <p><strong>Firebase is already configured!</strong></p>
                    <p>Your data will sync automatically across all devices.</p>
                </div>
            </div>

            <button class="btn-primary" onclick="completeSetup()">Start Using POS System</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div>
            <div class="spinner"></div>
            <p style="text-align: center; font-weight: 600;">Initializing POS System...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="switchTab('waiter')">
                        <span>üõí</span>
                        <span>Waiter</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('kitchen')">
                        <span>üë®‚Äçüç≥</span>
                        <span>Kitchen</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('checkout')">
                        <span>üí∞</span>
                        <span>Checkout</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('management')">
                        <span>‚öôÔ∏è</span>
                        <span>Management</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('expenses')">
                        <span>üìä</span>
                        <span>Expenses</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('reports')">
                        <span>üìà</span>
                        <span>Reports</span>
                    </button>
                </div>
                <div class="nav-actions">
                    <span id="sync-badge" class="sync-badge">‚òÅÔ∏è Online</span>
                    <button class="nav-btn" onclick="showSettings()">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- Waiter Tab -->
            <div id="waiter-tab" class="tab-content active">
                <div class="action-header">
                    <h2 class="section-title">Select Table</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-warning" onclick="showEditTablesModal()">Edit Tables</button>
                        <button class="btn-success" onclick="addNewTable()">+ Add Table</button>
                    </div>
                </div>
                <div id="tables-grid" class="tables-grid"></div>
                
                <div id="menu-section" style="display: none;">
                    <div class="action-header">
                        <h2 class="section-title">Menu - Table <span id="selected-table-num"></span></h2>
                        <button class="btn-warning" onclick="showEditMenuModal()">Edit Menu</button>
                    </div>
                    <div id="menu-categories" class="menu-categories"></div>
                </div>

                <div id="order-summary" class="order-summary" style="display: none;">
                    <h3>Current Order</h3>
                    <div id="order-items"></div>
                    <div class="order-total">Total: Rs.<span id="order-total">0.00</span></div>
                    <button class="btn-submit" onclick="submitOrder()">Submit to Kitchen</button>
                    <button class="btn-cancel" onclick="cancelOrder()">Cancel</button>
                </div>
            </div>

            <!-- Kitchen Tab -->
            <div id="kitchen-tab" class="tab-content">
                <h2 class="section-title">Kitchen Orders</h2>
                <div id="kitchen-orders" class="kitchen-orders"></div>
            </div>

            <!-- Checkout Tab -->
            <div id="checkout-tab" class="tab-content">
                <h2 class="section-title">Checkout</h2>
                <div class="checkout-section">
                    <div id="checkout-tables"></div>
                    <div id="checkout-details" style="display: none;">
                        <h3>Table <span id="checkout-table-num"></span></h3>
                        <div id="checkout-items"></div>
                        <div class="order-total">Total: Rs.<span id="checkout-total">0.00</span></div>
                        
                        <h3 style="margin-top: 1.5rem;">Payment Method</h3>
                        <div class="payment-methods">
                            <button class="payment-btn" onclick="selectPayment('Cash')">Cash</button>
                            <button class="payment-btn" onclick="selectPayment('QR')">QR/Card</button>
                            <button class="payment-btn" onclick="selectPayment('Both')">Both</button>
                        </div>
                        
                        <div id="split-payment" style="display: none;">
                            <div class="input-group">
                                <label>Cash Amount:</label>
                                <input type="number" id="cash-amount" class="input-field" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>QR Amount:</label>
                                <input type="number" id="qr-amount" class="input-field" step="0.01">
                            </div>
                        </div>
                        
                        <button class="btn-submit" onclick="processPayment()">Process Payment</button>
                        <button class="btn-cancel" onclick="cancelCheckout()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management-tab" class="tab-content">
                <h2 class="section-title">Management</h2>
                
                <div class="management-grid">
                    <!-- Menu Management -->
                    <div class="management-card">
                        <h3>üìã Menu Management</h3>
                        <p>Add, edit, or remove menu items and categories.</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="showEditMenuModal()">Edit Menu</button>
                        <button class="btn-secondary" style="margin-top: 0.5rem;" onclick="showAddCategoryModal()">Add Category</button>
                    </div>

                    <!-- Table Management -->
                    <div class="management-card">
                        <h3>ü™ë Table Management</h3>
                        <p>Configure tables, capacities, and statuses.</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="showEditTablesModal()">Edit Tables</button>
                        <button class="btn-secondary" style="margin-top: 0.5rem;" onclick="addNewTable()">Add Table</button>
                    </div>

                    <!-- Staff Management -->
                    <div class="management-card">
                        <h3>üë• Staff Management</h3>
                        <p>Manage staff roles and permissions.</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="showStaffModal()">Manage Staff</button>
                    </div>

                    <!-- Inventory Management -->
                    <div class="management-card">
                        <h3>üì¶ Inventory</h3>
                        <p>Track ingredients and stock levels.</p>
                        <button class="btn-primary" style="margin-top: 1rem;" onclick="showInventoryModal()">View Inventory</button>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content">
                <h2 class="section-title">Expenses</h2>
                <button class="btn-primary" style="max-width: 300px; margin-bottom: 1rem;" onclick="showAddExpenseModal()">+ Add Expense</button>
                <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 0.75rem;">
                    <h3>Total Expenses: Rs.<span id="total-expenses">0.00</span></h3>
                </div>
                <div id="expenses-list"></div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <h2 class="section-title">Reports & Analytics</h2>
                
                <div class="date-picker">
                    <input type="date" id="report-start-date" class="date-input" onchange="generateReports()">
                    <input type="date" id="report-end-date" class="date-input" onchange="generateReports()">
                    <button class="btn-primary" style="width: auto;" onclick="setDateRange('today')">Today</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('week')">This Week</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('month')">This Month</button>
                </div>

                <div class="reports-grid">
                    <!-- Sales Summary -->
                    <div class="report-card">
                        <div class="report-title">üìä Sales Summary</div>
                        <div class="stat-value" id="total-sales">Rs.0.00</div>
                        <div class="stat-label">Total Revenue</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="cash-sales">Rs.0.00</div>
                                <div class="stat-label">Cash Payments</div>
                            </div>
                            <div>
                                <div class="stat-value" id="digital-sales">Rs.0.00</div>
                                <div class="stat-label">Digital Payments</div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Summary -->
                    <div class="report-card">
                        <div class="report-title">üì¶ Orders Summary</div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="avg-order-value">Rs.0.00</div>
                                <div class="stat-label">Average Order Value</div>
                            </div>
                            <div>
                                <div class="stat-value" id="tables-turned">0</div>
                                <div class="stat-label">Tables Turned</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Summary -->
                    <div class="report-card">
                        <div class="report-title">üí∞ Expenses Summary</div>
                        <div class="stat-value" id="total-expenses-report">Rs.0.00</div>
                        <div class="stat-label">Total Expenses</div>
                        <div class="chart-container">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Items -->
                    <div class="report-card">
                        <div class="report-title">üèÜ Top Selling Items</div>
                        <div id="top-items-list" style="margin-top: 1rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Profit Summary -->
                    <div class="report-card">
                        <div class="report-title">üíµ Profit Summary</div>
                        <div class="stat-value" id="net-profit">Rs.0.00</div>
                        <div class="stat-label">Net Profit</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="profit-margin">0%</div>
                                <div class="stat-label">Profit Margin</div>
                            </div>
                            <div>
                                <div class="stat-value" id="expenses-percentage">0%</div>
                                <div class="stat-label">Expenses % of Revenue</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Sales -->
                    <div class="report-card">
                        <div class="report-title">‚è∞ Hourly Sales</div>
                        <div class="chart-container">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div style="margin-top: 2rem;">
                    <h3 class="section-title">Detailed Reports</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="exportSalesReport()">Export Sales Report</button>
                        <button class="btn-secondary" onclick="exportExpensesReport()">Export Expenses Report</button>
                        <button class="btn-secondary" onclick="exportInventoryReport()">Export Inventory Report</button>
                        <button class="btn-secondary" onclick="exportMenuReport()">Export Menu Report</button>
                    </div>
                    <div id="detailed-reports"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Add Expense</h2>
            <div class="input-group">
                <label for="expense-description">Description:</label>
                <input type="text" id="expense-description" class="input-field" placeholder="What was the expense for?">
            </div>
            <div class="input-group">
                <label for="expense-amount">Amount (Rs.):</label>
                <input type="number" id="expense-amount" class="input-field" step="0.01" min="0">
            </div>
            <div class="input-group">
                <label for="expense-category">Category:</label>
                <select id="expense-category" class="input-field">
                    <option value="Food">Food & Ingredients</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Salary">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="expense-date">Date:</label>
                <input type="date" id="expense-date" class="input-field" value="">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn-primary" onclick="saveExpense()">Save Expense</button>
                <button class="btn-cancel" onclick="hideAddExpenseModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Menu Modal -->
    <div id="edit-menu-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Edit Menu</h2>
            <div style="margin-bottom: 1rem;">
                <button class="btn-success" onclick="showAddMenuItemModal()">+ Add Menu Item</button>
            </div>
            <div id="menu-edit-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Menu items will be loaded here -->
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn-primary" onclick="saveMenuChanges()">Save Changes</button>
                <button class="btn-cancel" onclick="hideEditMenuModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Menu Item Modal -->
    <div id="add-menu-item-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Add Menu Item</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="item-name">Item Name:</label>
                    <input type="text" id="item-name" class="input-field" placeholder="e.g., Chicken Momo">
                </div>
                <div class="input-group">
                    <label for="item-price">Price (Rs.):</label>
                    <input type="number" id="item-price" class="input-field" step="0.01" min="0" value="100">
                </div>
                <div class="input-group">
                    <label for="item-category">Category:</label>
                    <input type="text" id="item-category" class="input-field" placeholder="e.g., Main Course" list="categories-list">
                    <datalist id="categories-list">
                        <option value="Main Course">
                        <option value="Starters">
                        <option value="Sides">
                        <option value="Drinks">
                        <option value="Desserts">
                    </datalist>
                </div>
                <div class="input-group">
                    <label for="item-description">Description:</label>
                    <textarea id="item-description" class="input-field" placeholder="Optional description"></textarea>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn-primary" onclick="saveMenuItem()">Add Item</button>
                <button class="btn-cancel" onclick="hideAddMenuItemModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Tables Modal -->
    <div id="edit-tables-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Edit Tables</h2>
            <div id="tables-edit-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem;">
                <!-- Tables will be loaded here -->
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-success" onclick="addNewTable()">+ Add Table</button>
                <button class="btn-primary" onclick="saveTablesChanges()">Save Changes</button>
                <button class="btn-cancel" onclick="hideEditTablesModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Settings</h2>
            <div class="setup-step">
                <h3>Restaurant Settings</h3>
                <div class="input-group">
                    <label for="settings-restaurant-name">Restaurant Name:</label>
                    <input type="text" id="settings-restaurant-name" class="input-field">
                </div>
                <div class="input-group">
                    <label for="settings-table-count">Number of Tables:</label>
                    <input type="number" id="settings-table-count" class="input-field" min="1" max="50">
                </div>
                <button class="btn-secondary" onclick="updateRestaurantSettings()">Update Settings</button>
            </div>
            <div class="setup-step">
                <h3>Sync Status</h3>
                <div id="sync-status" style="padding: 0.5rem; background: #f3f4f6; border-radius: 0.25rem; font-size: 0.875rem;">
                    Firebase: Connected ‚úì
                </div>
            </div>
            <div class="setup-step">
                <h3>Danger Zone</h3>
                <button class="btn-danger" onclick="resetAllData()">Reset All Data</button>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn-primary" onclick="hideSettingsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYtZVzqu1J1nYFf-bGYRmDMjaisB8NfmM",
            authDomain: "cafeapp-6c468.firebaseapp.com",
            projectId: "cafeapp-6c468",
            storageBucket: "cafeapp-6c468.firebasestorage.app",
            messagingSenderId: "390607952424",
            appId: "1:390607952424:web:26760c408636676920f31d",
            measurementId: "G-P2ZK2EYNJK"
        };

        // Initialize Firebase
        let app, db, auth, analytics;
        let syncEnabled = true;
        let isOnline = true;
        
        // State
        let state = {
            restaurantName: 'My Restaurant',
            tableCount: 10,
            tables: [],
            menuItems: [],
            selectedTable: null,
            currentOrder: [],
            kitchenOrders: [],
            completedTransactions: [],
            expenses: [],
            paymentMethod: '',
            selectedCheckoutTable: null,
            reports: {
                startDate: new Date(),
                endDate: new Date()
            }
        };

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                analytics = firebase.analytics();
                
                // Sign in anonymously
                await auth.signInAnonymously();
                
                console.log('Firebase initialized successfully');
                setupRealtimeListeners();
                updateSyncBadge('Online', true);
                
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateSyncBadge('Offline', false);
                return false;
            }
        }

        // Setup realtime listeners
        function setupRealtimeListeners() {
            if (!db) return;

            // Listen for tables changes
            db.collection('tables').orderBy('number').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const table = change.doc.data();
                    const localTable = state.tables.find(t => t.id === table.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localTable || table.updatedAt > localTable.updatedAt) {
                            const index = state.tables.findIndex(t => t.id === table.id);
                            if (index >= 0) {
                                state.tables[index] = table;
                            } else {
                                state.tables.push(table);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.tables = state.tables.filter(t => t.id !== table.id);
                    }
                });
                renderTables();
            });

            // Listen for menu items
            db.collection('menuItems').orderBy('category').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const item = change.doc.data();
                    const localItem = state.menuItems.find(i => i.id === item.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localItem || item.updatedAt > localItem.updatedAt) {
                            const index = state.menuItems.findIndex(i => i.id === item.id);
                            if (index >= 0) {
                                state.menuItems[index] = item;
                            } else {
                                state.menuItems.push(item);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.menuItems = state.menuItems.filter(i => i.id !== item.id);
                    }
                });
                renderMenu();
            });

            // Listen for kitchen orders
            db.collection('kitchenOrders').orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                state.kitchenOrders = [];
                snapshot.forEach(doc => {
                    state.kitchenOrders.push(doc.data());
                });
                renderKitchen();
            });

            // Listen for transactions
            db.collection('transactions').orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                state.completedTransactions = [];
                snapshot.forEach(doc => {
                    state.completedTransactions.push(doc.data());
                });
                generateReports();
            });

            // Listen for expenses
            db.collection('expenses').orderBy('date', 'desc').onSnapshot((snapshot) => {
                state.expenses = [];
                snapshot.forEach(doc => {
                    state.expenses.push(doc.data());
                });
                renderExpenses();
                generateReports();
            });
        }

        // Sync data to Firebase
        async function syncToFirebase(collection, data) {
            if (!syncEnabled || !db) return;

            try {
                const docRef = db.collection(collection).doc(data.id.toString());
                await docRef.set({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncBadge('Offline', false);
                return false;
            }
        }

        // Update sync badge
        function updateSyncBadge(text, isOnline) {
            const badge = document.getElementById('sync-badge');
            badge.textContent = isOnline ? `‚òÅÔ∏è ${text}` : `‚ö†Ô∏è ${text}`;
            badge.classList.toggle('offline', !isOnline);
        }

        // Setup Wizard
        function selectSyncMethod(method) {
            document.getElementById('sync-firebase').checked = (method === 'firebase');
        }

        async function completeSetup() {
            const restaurantName = document.getElementById('restaurant-name').value || 'My Restaurant';
            const tableCount = parseInt(document.getElementById('table-count').value) || 10;
            
            state.restaurantName = restaurantName;
            state.tableCount = tableCount;

            // Initialize tables
            for (let i = 1; i <= tableCount; i++) {
                const table = {
                    id: i,
                    number: i,
                    name: `Table ${i}`,
                    capacity: 4,
                    status: 'vacant',
                    orders: [],
                    notes: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                await syncToFirebase('tables', table);
            }

            // Add default menu items if none exist
            const menuSnapshot = await db.collection('menuItems').get();
            if (menuSnapshot.empty) {
                const defaultMenu = [
                    { id: 1, name: 'Veg Momo', price: 150, category: 'Main Course', description: 'Steamed dumplings with vegetable filling' },
                    { id: 2, name: 'Chicken Momo', price: 180, category: 'Main Course', description: 'Steamed dumplings with chicken filling' },
                    { id: 3, name: 'Chowmein', price: 120, category: 'Main Course', description: 'Stir-fried noodles with vegetables' },
                    { id: 4, name: 'Fried Rice', price: 130, category: 'Main Course', description: 'Fried rice with mixed vegetables' },
                    { id: 5, name: 'Chicken Chilly', price: 250, category: 'Main Course', description: 'Spicy chicken with bell peppers' },
                    { id: 6, name: 'Veg Salad', price: 100, category: 'Starters', description: 'Fresh vegetable salad' },
                    { id: 7, name: 'French Fries', price: 80, category: 'Sides', description: 'Crispy fried potatoes' },
                    { id: 8, name: 'Coke', price: 60, category: 'Drinks', description: '330ml can' },
                    { id: 9, name: 'Mineral Water', price: 20, category: 'Drinks', description: '1L bottle' },
                    { id: 10, name: 'Ice Cream', price: 120, category: 'Desserts', description: 'Vanilla ice cream' }
                ];

                for (const item of defaultMenu) {
                    await syncToFirebase('menuItems', {
                        ...item,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
            }

            document.getElementById('setup-wizard').classList.add('hidden');
            await initializeApp();
        }

        // Initialize App
        async function initializeApp() {
            document.getElementById('loading-screen').classList.remove('hidden');

            // Initialize Firebase
            await initializeFirebase();

            // Set default date range for reports
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            state.reports.startDate = startOfMonth;
            state.reports.endDate = today;

            // Set date picker values
            document.getElementById('report-start-date').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = today.toISOString().split('T')[0];

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'block';

            generateReports();
        }

        // Render Functions
        function renderTables() {
            const grid = document.getElementById('tables-grid');
            if (!grid) return;

            // Sort tables by number
            const sortedTables = [...state.tables].sort((a, b) => a.number - b.number);
            
            grid.innerHTML = sortedTables.map(table => `
                <div class="table-card ${table.status === 'occupied' ? 'occupied' : ''} ${table.status === 'reserved' ? 'reserved' : ''} ${state.selectedTable === table.number ? 'selected' : ''}"
                     onclick="selectTable(${table.number})">
                    <div class="table-actions">
                        <button class="btn-small btn-warning" onclick="editTable(${table.id}); event.stopPropagation()">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteTable(${table.id}); event.stopPropagation()">üóëÔ∏è</button>
                    </div>
                    <div class="table-number">${table.number}</div>
                    <div class="table-status">${table.status.toUpperCase()}</div>
                    <div class="table-capacity">üë• ${table.capacity || 4} seats</div>
                    ${table.notes ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${table.notes}</div>` : ''}
                </div>
            `).join('');

            // Also render tables for checkout
            renderCheckout();
        }

        function selectTable(tableNum) {
            state.selectedTable = tableNum;
            const table = state.tables.find(t => t.number === tableNum);
            
            if (table) {
                state.currentOrder = table.orders || [];
                document.getElementById('selected-table-num').textContent = tableNum;
                document.getElementById('menu-section').style.display = 'block';
                document.getElementById('order-summary').style.display = 'block';
                
                renderMenu();
                renderOrderSummary();
                renderTables();
            }
        }

        function renderMenu() {
            const categories = [...new Set(state.menuItems.map(item => item.category))];
            const menuContainer = document.getElementById('menu-categories');
            
            if (!menuContainer) return;

            menuContainer.innerHTML = categories.map(category => `
                <div class="category-section">
                    <div class="category-title">
                        ${category}
                        <button class="btn-small btn-warning" onclick="editCategory('${category}')">‚úèÔ∏è</button>
                    </div>
                    ${state.menuItems
                        .filter(item => item.category === category)
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .map(item => `
                            <div class="menu-item" onclick="addToOrder(${item.id})">
                                <div class="menu-item-actions">
                                    <button class="btn-small btn-warning" onclick="editMenuItem(${item.id}); event.stopPropagation()">‚úèÔ∏è</button>
                                    <button class="btn-small btn-danger" onclick="deleteMenuItem(${item.id}); event.stopPropagation()">üóëÔ∏è</button>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${item.name}</div>
                                    ${item.description ? `<div style="font-size: 0.75rem; color: #6b7280;">${item.description}</div>` : ''}
                                </div>
                                <div style="font-weight: 700; color: #ea580c;">Rs.${item.price}</div>
                            </div>
                        `).join('')}
                </div>
            `).join('');
        }

        function addToOrder(itemId) {
            const menuItem = state.menuItems.find(i => i.id === itemId);
            if (!menuItem) return;

            const orderItem = state.currentOrder.find(i => i.id === itemId);
            
            if (orderItem) {
                orderItem.quantity++;
            } else {
                state.currentOrder.push({
                    id: menuItem.id,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1
                });
            }
            
            renderOrderSummary();
        }

        function renderOrderSummary() {
            const itemsContainer = document.getElementById('order-items');
            const total = state.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            itemsContainer.innerHTML = state.currentOrder.map(item => `
                <div class="order-item">
                    <span>${item.name}</span>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                    <span>Rs.${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('order-total').textContent = total.toFixed(2);
        }

        function updateQuantity(itemId, change) {
            const item = state.currentOrder.find(i => i.id === itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    state.currentOrder = state.currentOrder.filter(i => i.id !== itemId);
                }
                renderOrderSummary();
            }
        }

        async function submitOrder() {
            if (state.currentOrder.length === 0) {
                alert('Please add items to the order');
                return;
            }

            const table = state.tables.find(t => t.number === state.selectedTable);
            if (!table) {
                alert('Table not found');
                return;
            }

            table.status = 'occupied';
            table.orders = [...state.currentOrder];
            table.updatedAt = new Date().toISOString();

            const kitchenOrder = {
                id: Date.now(),
                tableNumber: state.selectedTable,
                tableId: table.id,
                items: [...state.currentOrder],
                status: 'pending',
                timestamp: new Date().toLocaleTimeString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            state.kitchenOrders.push(kitchenOrder);

            // Sync to Firebase
            await syncToFirebase('tables', table);
            await syncToFirebase('kitchenOrders', kitchenOrder);

            state.currentOrder = [];
            state.selectedTable = null;
            
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('order-summary').style.display = 'none';

            alert('Order submitted to kitchen!');
            renderTables();
        }

        function cancelOrder() {
            state.currentOrder = [];
            state.selectedTable = null;
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('order-summary').style.display = 'none';
            renderTables();
        }

        // Kitchen Functions
        function renderKitchen() {
            const container = document.getElementById('kitchen-orders');
            
            if (!container) return;

            if (state.kitchenOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No pending orders</p>';
                return;
            }

            container.innerHTML = state.kitchenOrders.map(order => `
                <div class="kitchen-order ${order.status}">
                    <div class="kitchen-order-header">
                        Table ${order.tableNumber}
                        <br><small>${order.timestamp}</small>
                    </div>
                    ${order.items.map(item => `
                        <div class="kitchen-order-item">
                            <strong>${item.name}</strong> x${item.quantity}
                            <div style="font-size: 0.875rem; color: #6b7280;">Rs.${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `).join('')}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn-primary" style="flex: 1;" onclick="markOrderReady(${order.id})">
                            ${order.status === 'pending' ? 'Mark Ready' : 'Ready ‚úì'}
                        </button>
                        <button class="btn-danger" onclick="cancelKitchenOrder(${order.id})">Cancel</button>
                    </div>
                </div>
            `).join('');
        }

        async function markOrderReady(orderId) {
            const order = state.kitchenOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'ready';
                order.updatedAt = new Date().toISOString();
                await syncToFirebase('kitchenOrders', order);
                renderKitchen();
            }
        }

        async function cancelKitchenOrder(orderId) {
            if (!confirm('Cancel this order?')) return;
            
            const order = state.kitchenOrders.find(o => o.id === orderId);
            if (order) {
                // Update table status
                const table = state.tables.find(t => t.number === order.tableNumber);
                if (table) {
                    table.status = 'vacant';
                    table.orders = [];
                    table.updatedAt = new Date().toISOString();
                    await syncToFirebase('tables', table);
                }
                
                // Remove from kitchen orders
                state.kitchenOrders = state.kitchenOrders.filter(o => o.id !== orderId);
                await db.collection('kitchenOrders').doc(orderId.toString()).delete();
                renderKitchen();
                renderTables();
            }
        }

        // Checkout Functions
        function renderCheckout() {
            const occupiedTables = state.tables.filter(t => t.status === 'occupied');
            const container = document.getElementById('checkout-tables');

            if (!container) return;

            if (occupiedTables.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No tables to checkout</p>';
                return;
            }

            container.innerHTML = occupiedTables.map(table => {
                const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                return `
                    <div class="checkout-table-card" onclick="selectCheckoutTable(${table.number})">
                        <h3>Table ${table.number}</h3>
                        <p>Items: ${table.orders.length}</p>
                        <p><strong>Total: Rs.${total.toFixed(2)}</strong></p>
                        ${table.notes ? `<p style="font-size: 0.875rem; color: #6b7280;">${table.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectCheckoutTable(tableNum) {
            state.selectedCheckoutTable = tableNum;
            const table = state.tables.find(t => t.number === tableNum);
            if (!table) return;

            const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            document.getElementById('checkout-table-num').textContent = tableNum;
            document.getElementById('checkout-items').innerHTML = table.orders.map(item => `
                <div class="order-item">
                    <span>${item.name} x${item.quantity}</span>
                    <span>Rs.${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('checkout-total').textContent = total.toFixed(2);
            document.getElementById('checkout-details').style.display = 'block';
            document.getElementById('checkout-tables').style.display = 'none';
        }

        function selectPayment(method) {
            state.paymentMethod = method;
            
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            document.getElementById('split-payment').style.display = method === 'Both' ? 'block' : 'none';
        }

        async function processPayment() {
            if (!state.paymentMethod) {
                alert('Please select a payment method');
                return;
            }

            const table = state.tables.find(t => t.number === state.selectedCheckoutTable);
            if (!table) {
                alert('Table not found');
                return;
            }

            const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let cashAmount = 0;
            let qrAmount = 0;

            if (state.paymentMethod === 'Cash') {
                cashAmount = total;
            } else if (state.paymentMethod === 'QR') {
                qrAmount = total;
            } else {
                cashAmount = parseFloat(document.getElementById('cash-amount').value) || 0;
                qrAmount = parseFloat(document.getElementById('qr-amount').value) || 0;

                if (Math.abs(cashAmount + qrAmount - total) > 0.01) {
                    alert('Total payment must equal bill amount');
                    return;
                }
            }

            const transaction = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                timestamp: new Date().toLocaleTimeString(),
                tableNumber: state.selectedCheckoutTable,
                items: [...table.orders],
                total: total,
                paymentMethod: state.paymentMethod,
                cashAmount: cashAmount,
                qrAmount: qrAmount,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Add to transactions
            await syncToFirebase('transactions', transaction);

            // Clear table
            table.status = 'vacant';
            table.orders = [];
            table.updatedAt = new Date().toISOString();
            await syncToFirebase('tables', table);

            // Remove from kitchen orders
            const kitchenOrder = state.kitchenOrders.find(o => o.tableNumber === state.selectedCheckoutTable);
            if (kitchenOrder) {
                await db.collection('kitchenOrders').doc(kitchenOrder.id.toString()).delete();
            }

            state.completedTransactions.push(transaction);

            alert('Payment processed successfully!');
            cancelCheckout();
            renderTables();
            renderCheckout();
            generateReports();
        }

        function cancelCheckout() {
            state.selectedCheckoutTable = null;
            state.paymentMethod = '';
            const details = document.getElementById('checkout-details');
            const tables = document.getElementById('checkout-tables');
            if (details && tables) {
                details.style.display = 'none';
                tables.style.display = 'block';
            }
            document.getElementById('cash-amount').value = '';
            document.getElementById('qr-amount').value = '';
        }

        // Expense Functions
        function renderExpenses() {
            const total = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalElement = document.getElementById('total-expenses');
            if (totalElement) {
                totalElement.textContent = total.toFixed(2);
            }

            const container = document.getElementById('expenses-list');
            if (!container) return;

            if (state.expenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No expenses recorded</p>';
                return;
            }

            container.innerHTML = state.expenses.slice().reverse().map(expense => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>${expense.description}</strong>
                        <strong style="color: #dc2626;">Rs.${expense.amount.toFixed(2)}</strong>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        ${expense.category} ‚Ä¢ ${expense.date} ${expense.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // Menu Management Functions
        function showEditMenuModal() {
            const modal = document.getElementById('edit-menu-modal');
            const list = document.getElementById('menu-edit-list');
            
            // Group items by category
            const itemsByCategory = {};
            state.menuItems.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            list.innerHTML = Object.entries(itemsByCategory).map(([category, items]) => `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #ea580c; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e5e7eb;">${category}</h4>
                    ${items.map(item => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div>
                                <strong>${item.name}</strong>
                                <div style="font-size: 0.875rem; color: #6b7280;">Rs.${item.price} ${item.description ? '‚Ä¢ ' + item.description : ''}</div>
                            </div>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn-small btn-warning" onclick="editMenuItem(${item.id})">Edit</button>
                                <button class="btn-small btn-danger" onclick="deleteMenuItem(${item.id})">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function hideEditMenuModal() {
            document.getElementById('edit-menu-modal').classList.add('hidden');
        }

        function showAddMenuItemModal() {
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-category').value = '';
            document.getElementById('item-description').value = '';
            document.getElementById('add-menu-item-modal').classList.remove('hidden');
        }

        function hideAddMenuItemModal() {
            document.getElementById('add-menu-item-modal').classList.add('hidden');
        }

        async function saveMenuItem() {
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value);
            const category = document.getElementById('item-category').value.trim();
            const description = document.getElementById('item-description').value.trim();

            if (!name || !price || !category) {
                alert('Please fill in all required fields');
                return;
            }

            // Generate ID (use timestamp for uniqueness)
            const id = Date.now();

            const menuItem = {
                id: id,
                name: name,
                price: price,
                category: category,
                description: description,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            await syncToFirebase('menuItems', menuItem);
            hideAddMenuItemModal();
            alert('Menu item added successfully!');
        }

        async function editMenuItem(itemId) {
            const item = state.menuItems.find(i => i.id === itemId);
            if (!item) return;

            const newName = prompt('Edit item name:', item.name);
            if (newName === null) return;

            const newPrice = parseFloat(prompt('Edit price:', item.price));
            if (isNaN(newPrice)) return;

            const newCategory = prompt('Edit category:', item.category);
            if (newCategory === null) return;

            const newDescription = prompt('Edit description:', item.description || '');

            item.name = newName;
            item.price = newPrice;
            item.category = newCategory;
            item.description = newDescription;
            item.updatedAt = new Date().toISOString();

            await syncToFirebase('menuItems', item);
            alert('Menu item updated!');
        }

        async function deleteMenuItem(itemId) {
            if (!confirm('Delete this menu item?')) return;

            await db.collection('menuItems').doc(itemId.toString()).delete();
            alert('Menu item deleted!');
        }

        function editCategory(category) {
            const newCategory = prompt('Edit category name:', category);
            if (newCategory && newCategory !== category) {
                // Update all items in this category
                const itemsToUpdate = state.menuItems.filter(item => item.category === category);
                itemsToUpdate.forEach(async (item) => {
                    item.category = newCategory;
                    item.updatedAt = new Date().toISOString();
                    await syncToFirebase('menuItems', item);
                });
                alert('Category updated!');
            }
        }

        // Table Management Functions
        function showEditTablesModal() {
            const modal = document.getElementById('edit-tables-modal');
            const list = document.getElementById('tables-edit-list');
            
            list.innerHTML = state.tables.sort((a, b) => a.number - b.number).map(table => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <strong>Table ${table.number}</strong>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            Capacity: ${table.capacity || 4} ‚Ä¢ Status: ${table.status}
                            ${table.notes ? '‚Ä¢ ' + table.notes : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn-small btn-warning" onclick="editTable(${table.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteTable(${table.id})">Delete</button>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function hideEditTablesModal() {
            document.getElementById('edit-tables-modal').classList.add('hidden');
        }

        async function addNewTable() {
            const tableNumber = prompt('Enter table number:');
            if (!tableNumber) return;

            const capacity = parseInt(prompt('Enter table capacity:', '4')) || 4;
            const notes = prompt('Enter notes (optional):', '');

            const table = {
                id: Date.now(), // Use timestamp as ID
                number: parseInt(tableNumber),
                name: `Table ${tableNumber}`,
                capacity: capacity,
                status: 'vacant',
                orders: [],
                notes: notes,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            await syncToFirebase('tables', table);
            alert('Table added successfully!');
            hideEditTablesModal();
        }

        async function editTable(tableId) {
            const table = state.tables.find(t => t.id === tableId);
            if (!table) return;

            const newNumber = prompt('Edit table number:', table.number);
            if (newNumber === null) return;

            const newCapacity = parseInt(prompt('Edit capacity:', table.capacity || 4));
            if (isNaN(newCapacity)) return;

            const newStatus = prompt('Edit status (vacant/occupied/reserved):', table.status);
            if (!['vacant', 'occupied', 'reserved'].includes(newStatus)) {
                alert('Invalid status');
                return;
            }

            const newNotes = prompt('Edit notes:', table.notes || '');

            table.number = parseInt(newNumber);
            table.name = `Table ${newNumber}`;
            table.capacity = newCapacity;
            table.status = newStatus;
            table.notes = newNotes;
            table.updatedAt = new Date().toISOString();

            await syncToFirebase('tables', table);
            alert('Table updated!');
            hideEditTablesModal();
        }

        async function deleteTable(tableId) {
            if (!confirm('Delete this table? This cannot be undone.')) return;

            await db.collection('tables').doc(tableId.toString()).delete();
            alert('Table deleted!');
            hideEditTablesModal();
        }

        function saveTablesChanges() {
            hideEditTablesModal();
        }

        // Reports Functions (same as before, but integrated)
        function generateReports() {
            const startDate = document.getElementById('report-start-date').value 
                ? new Date(document.getElementById('report-start-date').value)
                : state.reports.startDate;
                
            const endDate = document.getElementById('report-end-date').value
                ? new Date(document.getElementById('report-end-date').value)
                : state.reports.endDate;

            // Filter data by date range
            const filteredTransactions = state.completedTransactions.filter(t => {
                const transDate = new Date(t.date || t.createdAt);
                return transDate >= startDate && transDate <= endDate;
            });

            const filteredExpenses = state.expenses.filter(e => {
                const expDate = new Date(e.date || e.createdAt);
                return expDate >= startDate && expDate <= endDate;
            });

            // Calculate metrics
            const totalSales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const cashSales = filteredTransactions.filter(t => t.paymentMethod === 'Cash' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.cashAmount || t.total), 0);
            const digitalSales = filteredTransactions.filter(t => t.paymentMethod === 'QR' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.qrAmount || t.total), 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalSales - totalExpenses;
            const profitMargin = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
            const expensesPercentage = totalSales > 0 ? (totalExpenses / totalSales * 100).toFixed(1) : 0;

            // Update UI
            document.getElementById('total-sales').textContent = `Rs.${totalSales.toFixed(2)}`;
            document.getElementById('cash-sales').textContent = `Rs.${cashSales.toFixed(2)}`;
            document.getElementById('digital-sales').textContent = `Rs.${digitalSales.toFixed(2)}`;
            document.getElementById('total-orders').textContent = filteredTransactions.length;
            document.getElementById('avg-order-value').textContent = filteredTransactions.length > 0 
                ? `Rs.${(totalSales / filteredTransactions.length).toFixed(2)}` 
                : 'Rs.0.00';
            document.getElementById('tables-turned').textContent = new Set(filteredTransactions.map(t => t.tableNumber)).size;
            document.getElementById('total-expenses-report').textContent = `Rs.${totalExpenses.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `Rs.${netProfit.toFixed(2)}`;
            document.getElementById('profit-margin').textContent = `${profitMargin}%`;
            document.getElementById('expenses-percentage').textContent = `${expensesPercentage}%`;

            // Top items
            const itemSales = {};
            filteredTransactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = { quantity: 0, revenue: 0 };
                    }
                    itemSales[item.name].quantity += item.quantity;
                    itemSales[item.name].revenue += item.price * item.quantity;
                });
            });

            const topItems = Object.entries(itemSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            const topItemsList = document.getElementById('top-items-list');
            if (topItemsList) {
                topItemsList.innerHTML = topItems.map(([name, data], index) => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                        <span>${index + 1}. ${name}</span>
                        <span>${data.quantity} sold (Rs.${data.revenue.toFixed(2)})</span>
                    </div>
                `).join('') || '<p style="color: #6b7280; text-align: center;">No sales data</p>';
            }

            // Generate charts
            generateExpensesChart(filteredExpenses);
            generateHourlyChart(filteredTransactions);
        }

        function generateExpensesChart(expenses) {
            const ctx = document.getElementById('expensesChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            const categories = [...new Set(expenses.map(e => e.category))];
            const data = categories.map(cat => 
                expenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0)
            );

            ctx.chart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ea580c', '#3b82f6', '#16a34a', '#f59e0b',
                            '#8b5cf6', '#ef4444', '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateHourlyChart(transactions) {
            const ctx = document.getElementById('hourlyChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (ctx.chart) {
                ctx.chart.destroy();
            }

            const hours = Array.from({length: 24}, (_, i) => i);
            const salesByHour = hours.map(hour => 
                transactions.filter(t => {
                    const time = new Date(t.timestamp || t.createdAt);
                    return time.getHours() === hour;
                }).reduce((sum, t) => sum + t.total, 0)
            );

            ctx.chart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'Sales (Rs.)',
                        data: salesByHour,
                        borderColor: '#ea580c',
                        backgroundColor: 'rgba(234, 88, 12, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Export Functions
        function exportSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'SALES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Table,Items,Total,Payment Method,Cash Amount,QR Amount\n';
            
            state.completedTransactions.forEach(t => {
                const transDate = new Date(t.date || t.createdAt);
                if (transDate >= new Date(startDate) && transDate <= new Date(endDate)) {
                    const items = t.items.map(i => `${i.name} x${i.quantity}`).join('; ');
                    csv += `${t.date || transDate.toLocaleDateString()},${t.timestamp || transDate.toLocaleTimeString()},${t.tableNumber},"${items}",${t.total},${t.paymentMethod},${t.cashAmount || 0},${t.qrAmount || 0}\n`;
                }
            });

            downloadCSV(csv, `sales-report-${startDate}-to-${endDate}.csv`);
        }

        function exportExpensesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'EXPENSES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Description,Amount,Category\n';
            
            state.expenses.forEach(e => {
                const expDate = new Date(e.date || e.createdAt);
                if (expDate >= new Date(startDate) && expDate <= new Date(endDate)) {
                    csv += `${e.date || expDate.toLocaleDateString()},${e.timestamp || expDate.toLocaleTimeString()},"${e.description}",${e.amount},${e.category}\n`;
                }
            });

            downloadCSV(csv, `expenses-report-${startDate}-to-${endDate}.csv`);
        }

        function exportInventoryReport() {
            // Get all items sold
            const itemSales = {};
            state.completedTransactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = { 
                            quantity: 0, 
                            revenue: 0,
                            price: item.price 
                        };
                    }
                    itemSales[item.name].quantity += item.quantity;
                    itemSales[item.name].revenue += item.price * item.quantity;
                });
            });

            let csv = 'INVENTORY REPORT\n';
            csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csv += 'Item,Quantity Sold,Unit Price,Total Revenue\n';
            
            Object.entries(itemSales).forEach(([name, data]) => {
                csv += `${name},${data.quantity},${data.price},${data.revenue.toFixed(2)}\n`;
            });

            downloadCSV(csv, `inventory-report-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportMenuReport() {
            let csv = 'MENU REPORT\n';
            csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csv += 'Category,Item Name,Price,Description\n';
            
            // Group by category
            const itemsByCategory = {};
            state.menuItems.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            Object.entries(itemsByCategory).forEach(([category, items]) => {
                items.forEach(item => {
                    csv += `${category},"${item.name}",${item.price},"${item.description || ''}"\n`;
                });
            });

            downloadCSV(csv, `menu-report-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Modal Functions
        function showAddExpenseModal() {
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-expense-modal').classList.remove('hidden');
        }

        function hideAddExpenseModal() {
            document.getElementById('add-expense-modal').classList.add('hidden');
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
        }

        async function saveExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;

            if (!description || !amount || amount <= 0) {
                alert('Please enter valid expense details');
                return;
            }

            const expense = {
                id: Date.now(),
                description,
                amount,
                category,
                date: date || new Date().toISOString().split('T')[0],
                timestamp: new Date().toLocaleTimeString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            await syncToFirebase('expenses', expense);
            hideAddExpenseModal();
            alert('Expense added successfully!');
        }

        function showSettings() {
            document.getElementById('settings-restaurant-name').value = state.restaurantName;
            document.getElementById('settings-table-count').value = state.tableCount;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function updateRestaurantSettings() {
            const restaurantName = document.getElementById('settings-restaurant-name').value;
            const tableCount = parseInt(document.getElementById('settings-table-count').value);

            state.restaurantName = restaurantName;
            
            if (tableCount !== state.tableCount) {
                // Update table count
                state.tableCount = tableCount;
                
                // Get current tables
                const currentTables = state.tables.sort((a, b) => a.number - b.number);
                
                // Add or remove tables as needed
                if (tableCount > currentTables.length) {
                    // Add new tables
                    for (let i = currentTables.length + 1; i <= tableCount; i++) {
                        const table = {
                            id: Date.now() + i,
                            number: i,
                            name: `Table ${i}`,
                            capacity: 4,
                            status: 'vacant',
                            orders: [],
                            notes: '',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        await syncToFirebase('tables', table);
                    }
                } else if (tableCount < currentTables.length) {
                    // Remove extra tables (keep highest numbers)
                    const tablesToRemove = currentTables.slice(tableCount);
                    for (const table of tablesToRemove) {
                        await db.collection('tables').doc(table.id.toString()).delete();
                    }
                }
            }

            hideSettingsModal();
            alert('Settings updated successfully!');
        }

        async function resetAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data including Firebase. Are you sure?')) {
                return;
            }

            if (confirm('‚ö†Ô∏è This action cannot be undone. All orders, transactions, and settings will be lost.')) {
                // Delete all collections
                const collections = ['tables', 'menuItems', 'kitchenOrders', 'transactions', 'expenses'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }

                // Reload page to reset state
                location.reload();
            }
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            // Refresh relevant data when switching tabs
            if (tab === 'waiter') {
                renderTables();
            } else if (tab === 'kitchen') {
                renderKitchen();
            } else if (tab === 'checkout') {
                renderCheckout();
            } else if (tab === 'reports') {
                generateReports();
            }
        }

        // Date Range Functions
        function setDateRange(range) {
            const today = new Date();
            let startDate, endDate = today;

            switch(range) {
                case 'today':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
            }

            document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = endDate.toISOString().split('T')[0];
            generateReports();
        }

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncBadge('Online', true);
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncBadge('Offline', false);
        });

        // Start the app
        window.addEventListener('load', async () => {
            // Check if Firebase is configured
            try {
                await initializeFirebase();
                
                // Check if we have any tables in Firebase
                const tablesSnapshot = await db.collection('tables').get();
                if (tablesSnapshot.empty) {
                    // Show setup wizard if no tables exist
                    document.getElementById('setup-wizard').classList.remove('hidden');
                } else {
                    // Load existing data
                    await initializeApp();
                }
            } catch (error) {
                console.error('Failed to initialize:', error);
                alert('Failed to connect to Firebase. Please check your connection.');
            }
        });
    </script>
</body>
</html>