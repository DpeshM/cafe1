<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }

        /* Setup Wizard */
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .setup-wizard.hidden {
            display: none;
        }

        .wizard-content {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .wizard-subtitle {
            color: #6b7280;
            text-align: center;
            margin-bottom: 2rem;
        }

        .setup-step {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .setup-step h3 {
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-number {
            background: #ea580c;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .setup-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .setup-option:hover {
            border-color: #ea580c;
            background: #ffedd5;
        }

        .setup-option input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #ea580c;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            background-color: #ea580c;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 1.125rem;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #c2410c;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .info-box code {
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #dc2626;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 64px;
            height: 64px;
            border: 4px solid #f3f4f6;
            border-top-color: #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation */
        .nav-bar {
            background-color: #ea580c;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background-color: #c2410c;
        }

        .nav-btn.active {
            background-color: #000;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sync-badge {
            background: #dcfce7;
            color: #166534;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .sync-badge.offline {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #ea580c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-card.occupied {
            background-color: #fee2e2;
            border-color: #ef4444;
        }

        .table-card.selected {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        .table-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .table-status {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Menu */
        .menu-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .category-section {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background: white;
        }

        .category-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        /* Order Summary */
        .order-summary {
            position: fixed;
            right: 1rem;
            top: 5rem;
            width: 320px;
            background: white;
            border: 2px solid #ea580c;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            max-height: calc(100vh - 6rem);
            overflow-y: auto;
        }

        .order-summary h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            gap: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ea580c;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            color: #ea580c;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .qty-btn:hover {
            background: #ea580c;
            color: white;
        }

        .order-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #111827;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .btn-submit {
            width: 100%;
            background: #16a34a;
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn-submit:hover {
            background: #15803d;
        }

        .btn-cancel {
            width: 100%;
            background: #dc2626;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        /* Kitchen Orders */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .kitchen-order {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
        }

        .kitchen-order.pending {
            border-color: #f59e0b;
            background-color: #fef3c7;
        }

        .kitchen-order.ready {
            border-color: #16a34a;
            background-color: #dcfce7;
        }

        .kitchen-order-header {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .kitchen-order-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Checkout */
        .checkout-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-btn {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .payment-btn.selected {
            border-color: #ea580c;
            background-color: #ffedd5;
        }

        .checkout-table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .checkout-table-card:hover {
            border-color: #ea580c;
            background: #ffedd5;
        }

        /* Expenses */
        .expense-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        /* Reports */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            margin: 1rem 0;
        }

        .stat-label {
            color: #6b7280;
            text-align: center;
            font-size: 0.875rem;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .date-picker {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .date-input {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .order-summary {
                position: static;
                width: 100%;
                margin-top: 2rem;
            }

            .menu-categories {
                grid-template-columns: 1fr;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                width: 100%;
            }

            .nav-btn span:last-child {
                display: none;
            }

            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .section-title {
                font-size: 1.25rem;
            }

            .wizard-content {
                padding: 2rem 1.5rem;
            }

            .date-picker {
                flex-direction: column;
            }
        }
    </style>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Setup Wizard -->
    <div id="setup-wizard" class="setup-wizard">
        <div class="wizard-content">
            <h1 class="wizard-title">üçΩÔ∏è Restaurant POS Setup</h1>
            <p class="wizard-subtitle">Configure your POS system</p>

            <div class="setup-step">
                <h3><span class="step-number">1</span> Choose Sync Method</h3>
                <div class="setup-option" onclick="selectSyncMethod('none')">
                    <input type="radio" name="sync" id="sync-none">
                    <label for="sync-none">
                        <strong>No Sync (Single Device)</strong><br>
                        <small>Data saved locally only</small>
                    </label>
                </div>
                <div class="setup-option" onclick="selectSyncMethod('firebase')">
                    <input type="radio" name="sync" id="sync-firebase" checked>
                    <label for="sync-firebase">
                        <strong>Firebase Sync (Multi-Device)</strong><br>
                        <small>Real-time sync across all devices</small>
                    </label>
                </div>
                <div class="setup-option" onclick="selectSyncMethod('sheets')">
                    <input type="radio" name="sync" id="sync-sheets">
                    <label for="sync-sheets">
                        <strong>Google Sheets Sync</strong><br>
                        <small>Backup to Google Sheets</small>
                    </label>
                </div>
            </div>

            <div id="firebase-setup" class="setup-step">
                <h3><span class="step-number">2</span> Firebase Setup</h3>
                
                <div class="info-box">
                    <p><strong>How to get Firebase credentials:</strong></p>
                    <p>1. Go to <a href="https://firebase.google.com" target="_blank">Firebase Console</a></p>
                    <p>2. Create a new project</p>
                    <p>3. Add a Web App to your project</p>
                    <p>4. Copy the Firebase Config</p>
                </div>

                <div class="input-group">
                    <label for="firebase-apiKey">API Key:</label>
                    <input type="text" id="firebase-apiKey" class="input-field" placeholder="AIzaSy...">
                </div>

                <div class="input-group">
                    <label for="firebase-authDomain">Auth Domain:</label>
                    <input type="text" id="firebase-authDomain" class="input-field" placeholder="your-app.firebaseapp.com">
                </div>

                <div class="input-group">
                    <label for="firebase-projectId">Project ID:</label>
                    <input type="text" id="firebase-projectId" class="input-field" placeholder="your-project-id">
                </div>

                <div class="input-group">
                    <label for="firebase-storageBucket">Storage Bucket:</label>
                    <input type="text" id="firebase-storageBucket" class="input-field" placeholder="your-app.appspot.com">
                </div>

                <div class="input-group">
                    <label for="firebase-messagingSenderId">Messaging Sender ID:</label>
                    <input type="text" id="firebase-messagingSenderId" class="input-field" placeholder="1234567890">
                </div>

                <div class="input-group">
                    <label for="firebase-appId">App ID:</label>
                    <input type="text" id="firebase-appId" class="input-field" placeholder="1:1234567890:web:...">
                </div>
            </div>

            <div id="sheets-setup" style="display: none;">
                <div class="setup-step">
                    <h3><span class="step-number">2</span> Google Sheets Setup</h3>
                    
                    <div class="info-box">
                        <p><strong>How to get your Google Sheets Web App URL:</strong></p>
                        <p>1. Create a Google Sheet</p>
                        <p>2. Go to <strong>Extensions ‚Üí Apps Script</strong></p>
                        <p>3. Paste the provided script</p>
                        <p>4. Click <strong>Deploy ‚Üí New Deployment</strong></p>
                        <p>5. Select type: <strong>Web App</strong></p>
                        <p>6. Set access: <strong>Anyone</strong></p>
                        <p>7. Copy the <strong>Web App URL</strong></p>
                    </div>

                    <div class="input-group">
                        <label for="sheet-url">Google Sheets Web App URL:</label>
                        <textarea id="sheet-url" class="input-field" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"></textarea>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="completeSetup()">Start Using POS System</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div>
            <div class="spinner"></div>
            <p style="text-align: center; font-weight: 600;">Initializing POS System...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="switchTab('waiter')">
                        <span>üõí</span>
                        <span>Waiter</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('kitchen')">
                        <span>üë®‚Äçüç≥</span>
                        <span>Kitchen</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('checkout')">
                        <span>üí∞</span>
                        <span>Checkout</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('expenses')">
                        <span>üìä</span>
                        <span>Expenses</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('reports')">
                        <span>üìà</span>
                        <span>Reports</span>
                    </button>
                </div>
                <div class="nav-actions">
                    <span id="sync-badge" class="sync-badge"></span>
                    <button class="nav-btn" onclick="downloadReport()">
                        <span>‚¨áÔ∏è</span>
                        <span>Export</span>
                    </button>
                    <button class="nav-btn" onclick="showSettings()">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- Waiter Tab -->
            <div id="waiter-tab" class="tab-content active">
                <h2 class="section-title">Select Table</h2>
                <div id="tables-grid" class="tables-grid"></div>
                
                <div id="menu-section" style="display: none;">
                    <h2 class="section-title">Menu - Table <span id="selected-table-num"></span></h2>
                    <div id="menu-categories" class="menu-categories"></div>
                </div>

                <div id="order-summary" class="order-summary" style="display: none;">
                    <h3>Current Order</h3>
                    <div id="order-items"></div>
                    <div class="order-total">Total: Rs.<span id="order-total">0.00</span></div>
                    <button class="btn-submit" onclick="submitOrder()">Submit to Kitchen</button>
                    <button class="btn-cancel" onclick="cancelOrder()">Cancel</button>
                </div>
            </div>

            <!-- Kitchen Tab -->
            <div id="kitchen-tab" class="tab-content">
                <h2 class="section-title">Kitchen Orders</h2>
                <div id="kitchen-orders" class="kitchen-orders"></div>
            </div>

            <!-- Checkout Tab -->
            <div id="checkout-tab" class="tab-content">
                <h2 class="section-title">Checkout</h2>
                <div class="checkout-section">
                    <div id="checkout-tables"></div>
                    <div id="checkout-details" style="display: none;">
                        <h3>Table <span id="checkout-table-num"></span></h3>
                        <div id="checkout-items"></div>
                        <div class="order-total">Total: Rs.<span id="checkout-total">0.00</span></div>
                        
                        <h3 style="margin-top: 1.5rem;">Payment Method</h3>
                        <div class="payment-methods">
                            <button class="payment-btn" onclick="selectPayment('Cash')">Cash</button>
                            <button class="payment-btn" onclick="selectPayment('QR')">QR/Card</button>
                            <button class="payment-btn" onclick="selectPayment('Both')">Both</button>
                        </div>
                        
                        <div id="split-payment" style="display: none;">
                            <div class="input-group">
                                <label>Cash Amount:</label>
                                <input type="number" id="cash-amount" class="input-field" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>QR Amount:</label>
                                <input type="number" id="qr-amount" class="input-field" step="0.01">
                            </div>
                        </div>
                        
                        <button class="btn-submit" onclick="processPayment()">Process Payment</button>
                        <button class="btn-cancel" onclick="cancelCheckout()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content">
                <h2 class="section-title">Expenses</h2>
                <button class="btn-primary" style="max-width: 300px; margin-bottom: 1rem;" onclick="showAddExpenseModal()">+ Add Expense</button>
                <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 0.75rem;">
                    <h3>Total Expenses: Rs.<span id="total-expenses">0.00</span></h3>
                </div>
                <div id="expenses-list"></div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <h2 class="section-title">Reports & Analytics</h2>
                
                <div class="date-picker">
                    <input type="date" id="report-start-date" class="date-input" onchange="generateReports()">
                    <input type="date" id="report-end-date" class="date-input" onchange="generateReports()">
                    <button class="btn-primary" style="width: auto;" onclick="setDateRange('today')">Today</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('week')">This Week</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('month')">This Month</button>
                </div>

                <div class="reports-grid">
                    <!-- Sales Summary -->
                    <div class="report-card">
                        <div class="report-title">üìä Sales Summary</div>
                        <div class="stat-value" id="total-sales">Rs.0.00</div>
                        <div class="stat-label">Total Revenue</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="cash-sales">Rs.0.00</div>
                                <div class="stat-label">Cash Payments</div>
                            </div>
                            <div>
                                <div class="stat-value" id="digital-sales">Rs.0.00</div>
                                <div class="stat-label">Digital Payments</div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Summary -->
                    <div class="report-card">
                        <div class="report-title">üì¶ Orders Summary</div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="avg-order-value">Rs.0.00</div>
                                <div class="stat-label">Average Order Value</div>
                            </div>
                            <div>
                                <div class="stat-value" id="tables-turned">0</div>
                                <div class="stat-label">Tables Turned</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Summary -->
                    <div class="report-card">
                        <div class="report-title">üí∞ Expenses Summary</div>
                        <div class="stat-value" id="total-expenses-report">Rs.0.00</div>
                        <div class="stat-label">Total Expenses</div>
                        <div class="chart-container">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Items -->
                    <div class="report-card">
                        <div class="report-title">üèÜ Top Selling Items</div>
                        <div id="top-items-list" style="margin-top: 1rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Profit Summary -->
                    <div class="report-card">
                        <div class="report-title">üíµ Profit Summary</div>
                        <div class="stat-value" id="net-profit">Rs.0.00</div>
                        <div class="stat-label">Net Profit</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="profit-margin">0%</div>
                                <div class="stat-label">Profit Margin</div>
                            </div>
                            <div>
                                <div class="stat-value" id="expenses-percentage">0%</div>
                                <div class="stat-label">Expenses % of Revenue</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Sales -->
                    <div class="report-card">
                        <div class="report-title">‚è∞ Hourly Sales</div>
                        <div class="chart-container">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div style="margin-top: 2rem;">
                    <h3 class="section-title">Detailed Reports</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn-primary" onclick="exportSalesReport()">Export Sales Report</button>
                        <button class="btn-secondary" onclick="exportExpensesReport()">Export Expenses Report</button>
                        <button class="btn-secondary" onclick="exportInventoryReport()">Export Inventory Report</button>
                    </div>
                    <div id="detailed-reports"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Add Expense</h2>
            <div class="input-group">
                <label for="expense-description">Description:</label>
                <input type="text" id="expense-description" class="input-field" placeholder="What was the expense for?">
            </div>
            <div class="input-group">
                <label for="expense-amount">Amount (Rs.):</label>
                <input type="number" id="expense-amount" class="input-field" step="0.01" min="0">
            </div>
            <div class="input-group">
                <label for="expense-category">Category:</label>
                <select id="expense-category" class="input-field">
                    <option value="Food">Food & Ingredients</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Salary">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="expense-date">Date:</label>
                <input type="date" id="expense-date" class="input-field" value="">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn-primary" onclick="saveExpense()">Save Expense</button>
                <button class="btn-cancel" onclick="hideAddExpenseModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Settings</h2>
            <div class="setup-step">
                <h3>Sync Settings</h3>
                <div style="margin-bottom: 1rem;">
                    <label>
                        <input type="checkbox" id="enable-sync" onchange="toggleSync()">
                        Enable Real-time Sync
                    </label>
                </div>
                <div id="sync-status" style="padding: 0.5rem; background: #f3f4f6; border-radius: 0.25rem; font-size: 0.875rem;"></div>
            </div>
            <div class="setup-step">
                <h3>Restaurant Settings</h3>
                <div class="input-group">
                    <label for="restaurant-name">Restaurant Name:</label>
                    <input type="text" id="restaurant-name" class="input-field">
                </div>
                <div class="input-group">
                    <label for="table-count">Number of Tables:</label>
                    <input type="number" id="table-count" class="input-field" min="1" max="50" value="10">
                </div>
                <button class="btn-secondary" onclick="updateRestaurantSettings()">Update Settings</button>
            </div>
            <div class="setup-step">
                <h3>Danger Zone</h3>
                <button class="btn-cancel" onclick="resetAllData()">Reset All Data</button>
                <button class="btn-cancel" style="background: #f59e0b; margin-top: 0.5rem;" onclick="clearLocalData()">Clear Local Data Only</button>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn-primary" onclick="hideSettingsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        let db = null;
        let auth = null;
        let syncEnabled = false;
        let isOnline = true;
        let pendingSync = [];
        
        // State
        let state = {
            restaurantName: 'My Restaurant',
            tableCount: 10,
            tables: [],
            menuItems: [],
            selectedTable: null,
            currentOrder: [],
            kitchenOrders: [],
            completedTransactions: [],
            expenses: [],
            paymentMethod: '',
            selectedCheckoutTable: null,
            reports: {
                startDate: new Date(),
                endDate: new Date()
            }
        };

        // Initialize Firebase
        async function initializeFirebase(config) {
            try {
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Sign in anonymously
                await auth.signInAnonymously();
                
                syncEnabled = true;
                setupRealtimeListeners();
                updateSyncBadge('Online', true);
                
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateSyncBadge('Offline', false);
                return false;
            }
        }

        // Setup realtime listeners
        function setupRealtimeListeners() {
            if (!db) return;

            // Listen for tables changes
            db.collection('tables').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const table = change.doc.data();
                    const localTable = state.tables.find(t => t.id === table.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localTable || table.updatedAt > localTable.updatedAt) {
                            const index = state.tables.findIndex(t => t.id === table.id);
                            if (index >= 0) {
                                state.tables[index] = table;
                            } else {
                                state.tables.push(table);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.tables = state.tables.filter(t => t.id !== table.id);
                    }
                });
                renderTables();
            });

            // Listen for kitchen orders
            db.collection('kitchenOrders').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const order = change.doc.data();
                    const localOrder = state.kitchenOrders.find(o => o.id === order.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localOrder || order.updatedAt > localOrder.updatedAt) {
                            const index = state.kitchenOrders.findIndex(o => o.id === order.id);
                            if (index >= 0) {
                                state.kitchenOrders[index] = order;
                            } else {
                                state.kitchenOrders.push(order);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.kitchenOrders = state.kitchenOrders.filter(o => o.id !== order.id);
                    }
                });
                renderKitchen();
            });

            // Listen for transactions
            db.collection('transactions').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const transaction = change.doc.data();
                    const localTransaction = state.completedTransactions.find(t => t.id === transaction.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localTransaction || transaction.updatedAt > localTransaction.updatedAt) {
                            const index = state.completedTransactions.findIndex(t => t.id === transaction.id);
                            if (index >= 0) {
                                state.completedTransactions[index] = transaction;
                            } else {
                                state.completedTransactions.push(transaction);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.completedTransactions = state.completedTransactions.filter(t => t.id !== transaction.id);
                    }
                });
                generateReports();
            });

            // Listen for expenses
            db.collection('expenses').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const expense = change.doc.data();
                    const localExpense = state.expenses.find(e => e.id === expense.id);
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        if (!localExpense || expense.updatedAt > localExpense.updatedAt) {
                            const index = state.expenses.findIndex(e => e.id === expense.id);
                            if (index >= 0) {
                                state.expenses[index] = expense;
                            } else {
                                state.expenses.push(expense);
                            }
                        }
                    } else if (change.type === 'removed') {
                        state.expenses = state.expenses.filter(e => e.id !== expense.id);
                    }
                });
                renderExpenses();
                generateReports();
            });
        }

        // Sync data to Firebase
        async function syncToFirebase(collection, data) {
            if (!syncEnabled || !db) return;

            try {
                const docRef = db.collection(collection).doc(data.id.toString());
                await docRef.set({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('Sync error:', error);
                pendingSync.push({ collection, data });
                updateSyncBadge('Syncing...', false);
                return false;
            }
        }

        // Update sync badge
        function updateSyncBadge(text, isOnline) {
            const badge = document.getElementById('sync-badge');
            badge.textContent = isOnline ? `‚òÅÔ∏è ${text}` : `‚ö†Ô∏è ${text}`;
            badge.classList.toggle('offline', !isOnline);
        }

        // Setup Wizard
        function selectSyncMethod(method) {
            document.getElementById('sync-none').checked = (method === 'none');
            document.getElementById('sync-firebase').checked = (method === 'firebase');
            document.getElementById('sync-sheets').checked = (method === 'sheets');
            document.getElementById('firebase-setup').style.display = method === 'firebase' ? 'block' : 'none';
            document.getElementById('sheets-setup').style.display = method === 'sheets' ? 'block' : 'none';
        }

        async function completeSetup() {
            const syncMethod = document.querySelector('input[name="sync"]:checked').value;
            
            if (syncMethod === 'firebase') {
                const config = {
                    apiKey: document.getElementById('firebase-apiKey').value,
                    authDomain: document.getElementById('firebase-authDomain').value,
                    projectId: document.getElementById('firebase-projectId').value,
                    storageBucket: document.getElementById('firebase-storageBucket').value,
                    messagingSenderId: document.getElementById('firebase-messagingSenderId').value,
                    appId: document.getElementById('firebase-appId').value
                };
                
                const success = await initializeFirebase(config);
                if (!success) {
                    alert('Firebase setup failed. Please check your credentials.');
                    return;
                }
            }

            await saveConfig({
                syncMethod,
                firebaseConfig: syncMethod === 'firebase' ? config : null,
                sheetUrl: syncMethod === 'sheets' ? document.getElementById('sheet-url').value : ''
            });

            document.getElementById('setup-wizard').classList.add('hidden');
            await initializeApp();
        }

        // Initialize App
        async function initializeApp() {
            document.getElementById('loading-screen').classList.remove('hidden');

            // Load config
            const config = await loadConfig();
            
            if (config.syncMethod === 'firebase' && config.firebaseConfig) {
                await initializeFirebase(config.firebaseConfig);
            }

            // Initialize tables
            state.tables = Array.from({length: state.tableCount}, (_, i) => ({
                id: i + 1,
                number: i + 1,
                status: 'vacant',
                orders: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            }));

            // Default menu
            state.menuItems = [
                { id: 1, name: 'Momo', price: 150, category: 'Main' },
                { id: 2, name: 'Chowmein', price: 120, category: 'Main' },
                { id: 3, name: 'Fried Rice', price: 180, category: 'Main' },
                { id: 4, name: 'Chicken Chilly', price: 250, category: 'Main' },
                { id: 5, name: 'Veg Salad', price: 100, category: 'Starter' },
                { id: 6, name: 'French Fries', price: 80, category: 'Side' },
                { id: 7, name: 'Coke', price: 60, category: 'Drink' },
                { id: 8, name: 'Water', price: 20, category: 'Drink' },
                { id: 9, name: 'Ice Cream', price: 120, category: 'Dessert' },
                { id: 10, name: 'Kheer', price: 100, category: 'Dessert' }
            ];

            // Set default date range for reports
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            state.reports.startDate = startOfMonth;
            state.reports.endDate = today;

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'block';

            render();
            generateReports();
        }

        // Storage functions
        async function saveConfig(config) {
            localStorage.setItem('pos_config', JSON.stringify(config));
        }

        async function loadConfig() {
            const config = localStorage.getItem('pos_config');
            return config ? JSON.parse(config) : { syncMethod: 'none' };
        }

        // Enhanced render functions (same as before but with Firebase sync)
        function renderTables() {
            const grid = document.getElementById('tables-grid');
            grid.innerHTML = state.tables.map(table => `
                <div class="table-card ${table.status === 'occupied' ? 'occupied' : ''} ${state.selectedTable === table.number ? 'selected' : ''}"
                     onclick="selectTable(${table.number})">
                    <div class="table-number">${table.number}</div>
                    <div class="table-status">${table.status.toUpperCase()}</div>
                </div>
            `).join('');
        }

        async function submitOrder() {
            if (state.currentOrder.length === 0) {
                alert('Please add items to the order');
                return;
            }

            const table = state.tables.find(t => t.number === state.selectedTable);
            table.status = 'occupied';
            table.orders = [...state.currentOrder];

            const kitchenOrder = {
                id: Date.now(),
                tableNumber: state.selectedTable,
                items: [...state.currentOrder],
                status: 'pending',
                timestamp: new Date().toLocaleTimeString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            state.kitchenOrders.push(kitchenOrder);

            // Sync to Firebase
            if (syncEnabled) {
                await syncToFirebase('tables', table);
                await syncToFirebase('kitchenOrders', kitchenOrder);
            }

            state.currentOrder = [];
            state.selectedTable = null;
            
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('order-summary').style.display = 'none';

            alert('Order submitted to kitchen!');
            render();
        }

        // Reports Functions
        function generateReports() {
            const startDate = document.getElementById('report-start-date').value 
                ? new Date(document.getElementById('report-start-date').value)
                : state.reports.startDate;
                
            const endDate = document.getElementById('report-end-date').value
                ? new Date(document.getElementById('report-end-date').value)
                : state.reports.endDate;

            // Filter data by date range
            const filteredTransactions = state.completedTransactions.filter(t => {
                const transDate = new Date(t.date || t.createdAt);
                return transDate >= startDate && transDate <= endDate;
            });

            const filteredExpenses = state.expenses.filter(e => {
                const expDate = new Date(e.date || e.createdAt);
                return expDate >= startDate && expDate <= endDate;
            });

            // Calculate metrics
            const totalSales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const cashSales = filteredTransactions.filter(t => t.paymentMethod === 'Cash' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.cashAmount || t.total), 0);
            const digitalSales = filteredTransactions.filter(t => t.paymentMethod === 'QR' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.qrAmount || t.total), 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalSales - totalExpenses;
            const profitMargin = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
            const expensesPercentage = totalSales > 0 ? (totalExpenses / totalSales * 100).toFixed(1) : 0;

            // Update UI
            document.getElementById('total-sales').textContent = `Rs.${totalSales.toFixed(2)}`;
            document.getElementById('cash-sales').textContent = `Rs.${cashSales.toFixed(2)}`;
            document.getElementById('digital-sales').textContent = `Rs.${digitalSales.toFixed(2)}`;
            document.getElementById('total-orders').textContent = filteredTransactions.length;
            document.getElementById('avg-order-value').textContent = filteredTransactions.length > 0 
                ? `Rs.${(totalSales / filteredTransactions.length).toFixed(2)}` 
                : 'Rs.0.00';
            document.getElementById('tables-turned').textContent = new Set(filteredTransactions.map(t => t.tableNumber)).size;
            document.getElementById('total-expenses-report').textContent = `Rs.${totalExpenses.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `Rs.${netProfit.toFixed(2)}`;
            document.getElementById('profit-margin').textContent = `${profitMargin}%`;
            document.getElementById('expenses-percentage').textContent = `${expensesPercentage}%`;

            // Top items
            const itemSales = {};
            filteredTransactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = { quantity: 0, revenue: 0 };
                    }
                    itemSales[item.name].quantity += item.quantity;
                    itemSales[item.name].revenue += item.price * item.quantity;
                });
            });

            const topItems = Object.entries(itemSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            document.getElementById('top-items-list').innerHTML = topItems.map(([name, data], index) => `
                <div style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                    <span>${index + 1}. ${name}</span>
                    <span>${data.quantity} sold (Rs.${data.revenue.toFixed(2)})</span>
                </div>
            `).join('') || '<p style="color: #6b7280; text-align: center;">No sales data</p>';

            // Generate charts
            generateExpensesChart(filteredExpenses);
            generateHourlyChart(filteredTransactions);
        }

        function generateExpensesChart(expenses) {
            const ctx = document.getElementById('expensesChart').getContext('2d');
            const categories = [...new Set(expenses.map(e => e.category))];
            const data = categories.map(cat => 
                expenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0)
            );

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ea580c', '#3b82f6', '#16a34a', '#f59e0b',
                            '#8b5cf6', '#ef4444', '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateHourlyChart(transactions) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            const hours = Array.from({length: 24}, (_, i) => i);
            const salesByHour = hours.map(hour => 
                transactions.filter(t => {
                    const time = new Date(t.timestamp || t.createdAt);
                    return time.getHours() === hour;
                }).reduce((sum, t) => sum + t.total, 0)
            );

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'Sales (Rs.)',
                        data: salesByHour,
                        borderColor: '#ea580c',
                        backgroundColor: 'rgba(234, 88, 12, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function setDateRange(range) {
            const today = new Date();
            let startDate, endDate = today;

            switch(range) {
                case 'today':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
            }

            document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = endDate.toISOString().split('T')[0];
            generateReports();
        }

        function exportSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'SALES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Table,Items,Total,Payment Method,Cash Amount,QR Amount\n';
            
            state.completedTransactions.forEach(t => {
                const transDate = new Date(t.date || t.createdAt);
                if (transDate >= new Date(startDate) && transDate <= new Date(endDate)) {
                    const items = t.items.map(i => `${i.name} x${i.quantity}`).join('; ');
                    csv += `${t.date || transDate.toLocaleDateString()},${t.timestamp || transDate.toLocaleTimeString()},${t.tableNumber},"${items}",${t.total},${t.paymentMethod},${t.cashAmount || 0},${t.qrAmount || 0}\n`;
                }
            });

            downloadCSV(csv, `sales-report-${startDate}-to-${endDate}.csv`);
        }

        function exportExpensesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'EXPENSES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Description,Amount,Category\n';
            
            state.expenses.forEach(e => {
                const expDate = new Date(e.date || e.createdAt);
                if (expDate >= new Date(startDate) && expDate <= new Date(endDate)) {
                    csv += `${e.date || expDate.toLocaleDateString()},${e.timestamp || expDate.toLocaleTimeString()},"${e.description}",${e.amount},${e.category}\n`;
                }
            });

            downloadCSV(csv, `expenses-report-${startDate}-to-${endDate}.csv`);
        }

        function exportInventoryReport() {
            // Get all items sold
            const itemSales = {};
            state.completedTransactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = { 
                            quantity: 0, 
                            revenue: 0,
                            price: item.price 
                        };
                    }
                    itemSales[item.name].quantity += item.quantity;
                    itemSales[item.name].revenue += item.price * item.quantity;
                });
            });

            let csv = 'INVENTORY REPORT\n';
            csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csv += 'Item,Quantity Sold,Unit Price,Total Revenue\n';
            
            Object.entries(itemSales).forEach(([name, data]) => {
                csv += `${name},${data.quantity},${data.price},${data.revenue.toFixed(2)}\n`;
            });

            downloadCSV(csv, `inventory-report-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Modal functions
        function showAddExpenseModal() {
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-expense-modal').classList.remove('hidden');
        }

        function hideAddExpenseModal() {
            document.getElementById('add-expense-modal').classList.add('hidden');
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
        }

        async function saveExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;

            if (!description || !amount || amount <= 0) {
                alert('Please enter valid expense details');
                return;
            }

            const expense = {
                id: Date.now(),
                description,
                amount,
                category,
                date: date || new Date().toISOString().split('T')[0],
                timestamp: new Date().toLocaleTimeString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            state.expenses.push(expense);

            // Sync to Firebase
            if (syncEnabled) {
                await syncToFirebase('expenses', expense);
            }

            hideAddExpenseModal();
            renderExpenses();
            generateReports();
        }

        function showSettings() {
            document.getElementById('restaurant-name').value = state.restaurantName;
            document.getElementById('table-count').value = state.tableCount;
            document.getElementById('enable-sync').checked = syncEnabled;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function toggleSync() {
            syncEnabled = document.getElementById('enable-sync').checked;
            const status = syncEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('sync-status').textContent = `Sync ${status}`;
        }

        function updateRestaurantSettings() {
            state.restaurantName = document.getElementById('restaurant-name').value;
            const newTableCount = parseInt(document.getElementById('table-count').value);
            
            if (newTableCount !== state.tableCount) {
                state.tableCount = newTableCount;
                state.tables = Array.from({length: state.tableCount}, (_, i) => ({
                    id: i + 1,
                    number: i + 1,
                    status: 'vacant',
                    orders: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }));
                renderTables();
            }
            
            alert('Settings updated!');
        }

        function resetAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL data including Firebase. Are you sure?')) {
                localStorage.clear();
                if (syncEnabled && db) {
                    // Note: This requires Firebase security rules to allow deletion
                    alert('Firebase data must be deleted from the Firebase console.');
                }
                location.reload();
            }
        }

        function clearLocalData() {
            if (confirm('Clear local data only? Firebase data will remain.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncBadge('Online', true);
            processPendingSync();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncBadge('Offline', false);
        });

        async function processPendingSync() {
            while (pendingSync.length > 0 && isOnline && syncEnabled) {
                const pending = pendingSync.shift();
                await syncToFirebase(pending.collection, pending.data);
            }
            updateSyncBadge('Online', true);
        }

        // Start the app
        window.addEventListener('load', async () => {
            // Set default date values
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;

            const config = await loadConfig();
            if (Object.keys(config).length > 1) { // Has configuration
                document.getElementById('setup-wizard').classList.add('hidden');
                await initializeApp();
            }
        });

        // Keep other functions from original code (selectTable, addToOrder, renderOrderSummary, etc.)
        // They remain the same but now include Firebase sync calls where needed
    </script>
</body>
</html>