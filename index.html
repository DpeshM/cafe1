<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYtZVzqu1J1nYFf-bGYRmDMjaisB8NfmM",
            authDomain: "cafeapp-6c468.firebaseapp.com",
            projectId: "cafeapp-6c468",
            storageBucket: "cafeapp-6c468.firebasestorage.app",
            messagingSenderId: "390607952424",
            appId: "1:390607952424:web:26760c408636676920f31d",
            measurementId: "G-P2ZK2EYNJK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseModules = {
            collection, doc, setDoc, getDoc, onSnapshot, query, orderBy, serverTimestamp, signInAnonymously
        };

        console.log('Firebase initialized successfully');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }

        /* Setup Wizard */
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .setup-wizard.hidden {
            display: none;
        }

        .wizard-content {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #ea580c;
        }

        .btn-primary {
            background-color: #ea580c;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 1.125rem;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            background-color: #c2410c;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 64px;
            height: 64px;
            border: 4px solid #f3f4f6;
            border-top-color: #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Navigation */
        .nav-bar {
            background-color: #ea580c;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background-color: #c2410c;
        }

        .nav-btn.active {
            background-color: #000;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sync-badge {
            background: #dcfce7;
            color: #166534;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .sync-badge.offline {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #ea580c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Action Header */
        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .table-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-card.occupied {
            background-color: #fee2e2;
            border-color: #ef4444;
        }

        .table-card.selected {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        .table-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .table-status {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Menu */
        .menu-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .category-section {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background: white;
        }

        .category-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background-color: #ffedd5;
            border-color: #ea580c;
        }

        /* Order Summary */
        .order-summary {
            position: fixed;
            right: 1rem;
            top: 5rem;
            width: 320px;
            background: white;
            border: 2px solid #ea580c;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            max-height: calc(100vh - 6rem);
            overflow-y: auto;
        }

        .order-summary h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            gap: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ea580c;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            color: #ea580c;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .qty-btn:hover {
            background: #ea580c;
            color: white;
        }

        .order-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #111827;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .btn-submit {
            width: 100%;
            background: #16a34a;
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn-submit:hover {
            background: #15803d;
        }

        .btn-cancel {
            width: 100%;
            background: #dc2626;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        /* Kitchen Orders */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .kitchen-order {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
        }

        .kitchen-order.pending {
            border-color: #f59e0b;
            background-color: #fef3c7;
        }

        .kitchen-order.ready {
            border-color: #16a34a;
            background-color: #dcfce7;
        }

        .kitchen-order-header {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .kitchen-order-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Checkout */
        .checkout-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-btn {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .payment-btn.selected {
            border-color: #ea580c;
            background-color: #ffedd5;
        }

        .checkout-table-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .checkout-table-card:hover {
            border-color: #ea580c;
            background: #ffedd5;
        }

        /* Expenses */
        .expense-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        /* Reports */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background: white;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ea580c;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ea580c;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            margin: 1rem 0;
        }

        .stat-label {
            color: #6b7280;
            text-align: center;
            font-size: 0.875rem;
        }

        .date-picker {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Buttons */
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-success {
            background-color: #16a34a;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .order-summary {
                position: static;
                width: 100%;
                margin-top: 2rem;
            }

            .menu-categories {
                grid-template-columns: 1fr;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                width: 100%;
            }

            .nav-btn span:last-child {
                display: none;
            }

            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .section-title {
                font-size: 1.25rem;
            }

            .wizard-content {
                padding: 2rem 1.5rem;
            }

            .date-picker {
                flex-direction: column;
            }

            .action-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Wizard -->
    <div id="setup-wizard" class="setup-wizard">
        <div class="wizard-content">
            <h1 class="wizard-title">üçΩÔ∏è Restaurant POS Setup</h1>
            <p style="text-align: center; color: #6b7280; margin-bottom: 2rem;">Configure your restaurant</p>
            
            <div class="input-group">
                <label for="restaurant-name">Restaurant Name:</label>
                <input type="text" id="restaurant-name" class="input-field" placeholder="My Restaurant" value="My Restaurant">
            </div>

            <div class="input-group">
                <label for="table-count">Number of Tables:</label>
                <input type="number" id="table-count" class="input-field" min="1" max="50" value="10">
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                <p style="font-size: 0.875rem; color: #374151;">
                    <strong>Firebase is pre-configured!</strong> Your data will sync automatically across devices.
                </p>
            </div>

            <button class="btn-primary" onclick="completeSetup()">Start POS System</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen hidden">
        <div>
            <div class="spinner"></div>
            <p style="text-align: center; font-weight: 600;">Initializing POS System...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="switchTab('waiter')">
                        <span>üõí</span>
                        <span>Waiter</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('kitchen')">
                        <span>üë®‚Äçüç≥</span>
                        <span>Kitchen</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('checkout')">
                        <span>üí∞</span>
                        <span>Checkout</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('expenses')">
                        <span>üìä</span>
                        <span>Expenses</span>
                    </button>
                    <button class="nav-btn" onclick="switchTab('reports')">
                        <span>üìà</span>
                        <span>Reports</span>
                    </button>
                </div>
                <div class="nav-actions">
                    <span id="sync-badge" class="sync-badge">‚òÅÔ∏è Online</span>
                    <button class="nav-btn" onclick="showSettings()">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- Waiter Tab -->
            <div id="waiter-tab" class="tab-content active">
                <div class="action-header">
                    <h2 class="section-title">Select Table</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-warning" onclick="editTables()">Edit Tables</button>
                        <button class="btn-success" onclick="addTable()">+ Add Table</button>
                    </div>
                </div>
                <div id="tables-grid" class="tables-grid"></div>
                
                <div id="menu-section" style="display: none;">
                    <div class="action-header">
                        <h2 class="section-title">Menu - Table <span id="selected-table-num"></span></h2>
                        <button class="btn-warning" onclick="editMenu()">Edit Menu</button>
                    </div>
                    <div id="menu-categories" class="menu-categories"></div>
                </div>

                <div id="order-summary" class="order-summary" style="display: none;">
                    <h3>Current Order</h3>
                    <div id="order-items"></div>
                    <div class="order-total">Total: Rs.<span id="order-total">0.00</span></div>
                    <button class="btn-submit" onclick="submitOrder()">Submit to Kitchen</button>
                    <button class="btn-cancel" onclick="cancelOrder()">Cancel</button>
                </div>
            </div>

            <!-- Kitchen Tab -->
            <div id="kitchen-tab" class="tab-content">
                <h2 class="section-title">Kitchen Orders</h2>
                <div id="kitchen-orders" class="kitchen-orders"></div>
            </div>

            <!-- Checkout Tab -->
            <div id="checkout-tab" class="tab-content">
                <h2 class="section-title">Checkout</h2>
                <div class="checkout-section">
                    <div id="checkout-tables"></div>
                    <div id="checkout-details" style="display: none;">
                        <h3>Table <span id="checkout-table-num"></span></h3>
                        <div id="checkout-items"></div>
                        <div class="order-total">Total: Rs.<span id="checkout-total">0.00</span></div>
                        
                        <h3 style="margin-top: 1.5rem;">Payment Method</h3>
                        <div class="payment-methods">
                            <button class="payment-btn" onclick="selectPayment('Cash')">Cash</button>
                            <button class="payment-btn" onclick="selectPayment('QR')">QR/Card</button>
                            <button class="payment-btn" onclick="selectPayment('Both')">Both</button>
                        </div>
                        
                        <div id="split-payment" style="display: none;">
                            <div class="input-group">
                                <label>Cash Amount:</label>
                                <input type="number" id="cash-amount" class="input-field" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>QR Amount:</label>
                                <input type="number" id="qr-amount" class="input-field" step="0.01">
                            </div>
                        </div>
                        
                        <button class="btn-submit" onclick="processPayment()">Process Payment</button>
                        <button class="btn-cancel" onclick="cancelCheckout()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses-tab" class="tab-content">
                <h2 class="section-title">Expenses</h2>
                <button class="btn-primary" style="max-width: 300px; margin-bottom: 1rem;" onclick="showAddExpenseModal()">+ Add Expense</button>
                <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 0.75rem;">
                    <h3>Total Expenses: Rs.<span id="total-expenses">0.00</span></h3>
                </div>
                <div id="expenses-list"></div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <h2 class="section-title">Reports & Analytics</h2>
                
                <div class="date-picker">
                    <input type="date" id="report-start-date" class="date-input" onchange="generateReports()">
                    <input type="date" id="report-end-date" class="date-input" onchange="generateReports()">
                    <button class="btn-primary" style="width: auto;" onclick="setDateRange('today')">Today</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('week')">This Week</button>
                    <button class="btn-secondary" style="width: auto;" onclick="setDateRange('month')">This Month</button>
                </div>

                <div class="reports-grid">
                    <!-- Sales Summary -->
                    <div class="report-card">
                        <div class="report-title">üìä Sales Summary</div>
                        <div class="stat-value" id="total-sales">Rs.0.00</div>
                        <div class="stat-label">Total Revenue</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="cash-sales">Rs.0.00</div>
                                <div class="stat-label">Cash Payments</div>
                            </div>
                            <div>
                                <div class="stat-value" id="digital-sales">Rs.0.00</div>
                                <div class="stat-label">Digital Payments</div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Summary -->
                    <div class="report-card">
                        <div class="report-title">üì¶ Orders Summary</div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="avg-order-value">Rs.0.00</div>
                                <div class="stat-label">Average Order Value</div>
                            </div>
                            <div>
                                <div class="stat-value" id="tables-turned">0</div>
                                <div class="stat-label">Tables Turned</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Summary -->
                    <div class="report-card">
                        <div class="report-title">üí∞ Expenses Summary</div>
                        <div class="stat-value" id="total-expenses-report">Rs.0.00</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>

                    <!-- Top Items -->
                    <div class="report-card">
                        <div class="report-title">üèÜ Top Selling Items</div>
                        <div id="top-items-list" style="margin-top: 1rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Profit Summary -->
                    <div class="report-card">
                        <div class="report-title">üíµ Profit Summary</div>
                        <div class="stat-value" id="net-profit">Rs.0.00</div>
                        <div class="stat-label">Net Profit</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div class="stat-value" id="profit-margin">0%</div>
                                <div class="stat-label">Profit Margin</div>
                            </div>
                            <div>
                                <div class="stat-value" id="expenses-percentage">0%</div>
                                <div class="stat-label">Expenses % of Revenue</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div style="margin-top: 2rem;">
                    <h3 class="section-title">Detailed Reports</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="exportSalesReport()">Export Sales Report</button>
                        <button class="btn-secondary" onclick="exportExpensesReport()">Export Expenses Report</button>
                        <button class="btn-secondary" onclick="exportMenuReport()">Export Menu Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Add Expense</h2>
            <div class="input-group">
                <label for="expense-description">Description:</label>
                <input type="text" id="expense-description" class="input-field" placeholder="What was the expense for?">
            </div>
            <div class="input-group">
                <label for="expense-amount">Amount (Rs.):</label>
                <input type="number" id="expense-amount" class="input-field" step="0.01" min="0">
            </div>
            <div class="input-group">
                <label for="expense-category">Category:</label>
                <select id="expense-category" class="input-field">
                    <option value="Food">Food & Ingredients</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Salary">Salaries</option>
                    <option value="Rent">Rent</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group">
                <label for="expense-date">Date:</label>
                <input type="date" id="expense-date" class="input-field" value="">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn-primary" onclick="saveExpense()">Save Expense</button>
                <button class="btn-cancel" onclick="hideAddExpenseModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Settings</h2>
            
            <div class="input-group">
                <label for="settings-restaurant-name">Restaurant Name:</label>
                <input type="text" id="settings-restaurant-name" class="input-field">
            </div>
            
            <div class="input-group">
                <label for="settings-table-count">Number of Tables:</label>
                <input type="number" id="settings-table-count" class="input-field" min="1" max="50">
            </div>
            
            <div style="margin: 1rem 0; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                <p style="font-size: 0.875rem; color: #374151;">
                    <strong>Firebase Status:</strong> <span id="firebase-status">Connected</span>
                </p>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <button class="btn-primary" onclick="updateSettings()">Save Settings</button>
                <button class="btn-secondary" style="margin-top: 0.5rem;" onclick="hideSettingsModal()">Cancel</button>
                <button class="btn-danger" style="margin-top: 1rem;" onclick="resetData()">Reset All Data</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            restaurantName: 'My Restaurant',
            tableCount: 10,
            tables: [],
            menuItems: [],
            selectedTable: null,
            currentOrder: [],
            kitchenOrders: [],
            completedTransactions: [],
            expenses: [],
            paymentMethod: '',
            selectedCheckoutTable: null
        };

        // Firebase variables
        let db = null;
        let auth = null;
        let syncEnabled = false;
        let firebaseInitialized = false;

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                // Check if Firebase modules are available
                if (!window.firebaseDb || !window.firebaseModules) {
                    console.log('Firebase modules not loaded yet');
                    return false;
                }

                db = window.firebaseDb;
                auth = window.firebaseAuth;
                
                // Sign in anonymously
                try {
                    await window.firebaseModules.signInAnonymously(auth);
                    console.log('Signed in anonymously');
                } catch (authError) {
                    console.log('Anonymous sign-in not required');
                }
                
                syncEnabled = true;
                firebaseInitialized = true;
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.log('Firebase initialization error:', error);
                syncEnabled = false;
                return false;
            }
        }

        // Save data to Firebase or localStorage
        async function saveData(collectionName, data) {
            if (syncEnabled && db && firebaseInitialized) {
                try {
                    // Convert data to Firestore format
                    const firestoreData = {
                        ...data,
                        updatedAt: window.firebaseModules.serverTimestamp()
                    };
                    
                    const docRef = window.firebaseModules.doc(db, collectionName, data.id ? data.id.toString() : 'main');
                    await window.firebaseModules.setDoc(docRef, firestoreData, { merge: true });
                    console.log(`Saved to Firebase: ${collectionName}`);
                    return true;
                } catch (error) {
                    console.log('Firebase save failed:', error);
                    // Fallback to localStorage
                    localStorage.setItem(collectionName, JSON.stringify(data));
                    return false;
                }
            } else {
                localStorage.setItem(collectionName, JSON.stringify(data));
                return true;
            }
        }

        // Load data from Firebase or localStorage
        async function loadData(collectionName, defaultValue = []) {
            if (syncEnabled && db && firebaseInitialized) {
                try {
                    const docRef = window.firebaseModules.doc(db, collectionName, 'main');
                    const docSnap = await window.firebaseModules.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log(`Loaded from Firebase: ${collectionName}`);
                        // Remove Firestore metadata
                        const { updatedAt, ...cleanData } = data;
                        return cleanData;
                    }
                } catch (error) {
                    console.log('Firebase load failed:', error);
                }
            }
            
            // Fallback to localStorage
            const data = localStorage.getItem(collectionName);
            return data ? JSON.parse(data) : defaultValue;
        }

        // Setup real-time listener for a collection
        function setupRealtimeListener(collectionName, callback) {
            if (syncEnabled && db && firebaseInitialized) {
                try {
                    const q = window.firebaseModules.query(
                        window.firebaseModules.collection(db, collectionName),
                        window.firebaseModules.orderBy('updatedAt', 'desc')
                    );
                    
                    return window.firebaseModules.onSnapshot(q, (snapshot) => {
                        const data = [];
                        snapshot.forEach((doc) => {
                            const docData = doc.data();
                            const { updatedAt, ...cleanData } = docData;
                            data.push(cleanData);
                        });
                        callback(data);
                    });
                } catch (error) {
                    console.log(`Realtime listener error for ${collectionName}:`, error);
                }
            }
            return null;
        }

        // Setup Wizard
        async function completeSetup() {
            const restaurantName = document.getElementById('restaurant-name').value || 'My Restaurant';
            const tableCount = parseInt(document.getElementById('table-count').value) || 10;
            
            state.restaurantName = restaurantName;
            state.tableCount = tableCount;

            // Initialize Firebase
            document.getElementById('loading-screen').classList.remove('hidden');
            const firebaseSuccess = await initializeFirebase();
            
            if (firebaseSuccess) {
                document.getElementById('sync-badge').textContent = '‚òÅÔ∏è Online';
                console.log('Firebase connected successfully');
            } else {
                document.getElementById('sync-badge').textContent = 'üì± Local';
                document.getElementById('sync-badge').classList.add('offline');
                console.log('Using local storage');
            }

            // Create tables
            state.tables = [];
            for (let i = 1; i <= tableCount; i++) {
                state.tables.push({
                    id: i,
                    number: i,
                    status: 'vacant',
                    orders: []
                });
            }

            // Default menu items
            state.menuItems = [
                { id: 1, name: 'Momo', price: 150, category: 'Main' },
                { id: 2, name: 'Chowmein', price: 120, category: 'Main' },
                { id: 3, name: 'Fried Rice', price: 180, category: 'Main' },
                { id: 4, name: 'Chicken Chilly', price: 250, category: 'Main' },
                { id: 5, name: 'Veg Salad', price: 100, category: 'Starter' },
                { id: 6, name: 'French Fries', price: 80, category: 'Side' },
                { id: 7, name: 'Coke', price: 60, category: 'Drink' },
                { id: 8, name: 'Water', price: 20, category: 'Drink' },
                { id: 9, name: 'Ice Cream', price: 120, category: 'Dessert' },
                { id: 10, name: 'Kheer', price: 100, category: 'Dessert' }
            ];

            // Save initial data
            await saveData('config', { restaurantName, tableCount });
            await saveData('tables', { id: 'main', tables: state.tables });
            await saveData('menuItems', { id: 'main', items: state.menuItems });
            await saveData('kitchenOrders', { id: 'main', orders: [] });
            await saveData('transactions', { id: 'main', transactions: [] });
            await saveData('expenses', { id: 'main', expenses: [] });

            document.getElementById('setup-wizard').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            startApp();
        }

        // Start App
        async function startApp() {
            document.getElementById('loading-screen').classList.remove('hidden');
            
            // Try to load existing data
            try {
                // Load config
                const config = await loadData('config', {});
                if (config.restaurantName) {
                    state.restaurantName = config.restaurantName;
                    state.tableCount = config.tableCount || 10;
                }

                // Load tables
                const tablesData = await loadData('tables', {});
                if (tablesData.tables && tablesData.tables.length > 0) {
                    state.tables = tablesData.tables;
                }

                // Load menu items
                const menuData = await loadData('menuItems', {});
                if (menuData.items && menuData.items.length > 0) {
                    state.menuItems = menuData.items;
                }

                // Load kitchen orders
                const kitchenData = await loadData('kitchenOrders', {});
                if (kitchenData.orders) {
                    state.kitchenOrders = kitchenData.orders;
                }

                // Load transactions
                const transactionsData = await loadData('transactions', {});
                if (transactionsData.transactions) {
                    state.completedTransactions = transactionsData.transactions;
                }

                // Load expenses
                const expensesData = await loadData('expenses', {});
                if (expensesData.expenses) {
                    state.expenses = expensesData.expenses;
                }

                // Set up real-time listeners if Firebase is connected
                if (syncEnabled && db) {
                    setupRealtimeListener('tables', (data) => {
                        if (data[0] && data[0].tables) {
                            state.tables = data[0].tables;
                            renderTables();
                        }
                    });

                    setupRealtimeListener('menuItems', (data) => {
                        if (data[0] && data[0].items) {
                            state.menuItems = data[0].items;
                            renderMenu();
                        }
                    });

                    setupRealtimeListener('kitchenOrders', (data) => {
                        if (data[0] && data[0].orders) {
                            state.kitchenOrders = data[0].orders;
                            renderKitchen();
                        }
                    });

                    setupRealtimeListener('transactions', (data) => {
                        if (data[0] && data[0].transactions) {
                            state.completedTransactions = data[0].transactions;
                            generateReports();
                        }
                    });

                    setupRealtimeListener('expenses', (data) => {
                        if (data[0] && data[0].expenses) {
                            state.expenses = data[0].expenses;
                            renderExpenses();
                            generateReports();
                        }
                    });
                }

            } catch (error) {
                console.log('Error loading data:', error);
            }

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-app').style.display = 'block';

            render();
            generateReports();
        }

        // Render Functions
        function render() {
            renderTables();
            renderKitchen();
            renderCheckout();
            renderExpenses();
        }

        function renderTables() {
            const grid = document.getElementById('tables-grid');
            if (!grid) return;

            // Sort tables by number
            const sortedTables = [...state.tables].sort((a, b) => a.number - b.number);
            
            grid.innerHTML = sortedTables.map(table => `
                <div class="table-card ${table.status === 'occupied' ? 'occupied' : ''} ${state.selectedTable === table.number ? 'selected' : ''}"
                     onclick="selectTable(${table.number})">
                    <div class="table-number">${table.number}</div>
                    <div class="table-status">${table.status}</div>
                </div>
            `).join('');
        }

        function selectTable(tableNum) {
            const table = state.tables.find(t => t.number === tableNum);
            if (!table) return;

            state.selectedTable = tableNum;
            state.currentOrder = [...table.orders];
            
            document.getElementById('selected-table-num').textContent = tableNum;
            document.getElementById('menu-section').style.display = 'block';
            document.getElementById('order-summary').style.display = 'block';
            
            renderMenu();
            renderOrderSummary();
            renderTables();
        }

        function renderMenu() {
            const categories = [...new Set(state.menuItems.map(item => item.category))];
            const menuContainer = document.getElementById('menu-categories');
            if (!menuContainer) return;

            menuContainer.innerHTML = categories.map(category => `
                <div class="category-section">
                    <div class="category-title">${category}</div>
                    ${state.menuItems
                        .filter(item => item.category === category)
                        .map(item => `
                            <div class="menu-item" onclick="addToOrder(${item.id})">
                                <span>${item.name}</span>
                                <span>Rs.${item.price}</span>
                            </div>
                        `).join('')}
                </div>
            `).join('');
        }

        function addToOrder(itemId) {
            const menuItem = state.menuItems.find(i => i.id === itemId);
            if (!menuItem) return;

            const orderItem = state.currentOrder.find(i => i.id === itemId);
            
            if (orderItem) {
                orderItem.quantity++;
            } else {
                state.currentOrder.push({
                    id: menuItem.id,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1
                });
            }
            
            renderOrderSummary();
        }

        function renderOrderSummary() {
            const itemsContainer = document.getElementById('order-items');
            const total = state.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            itemsContainer.innerHTML = state.currentOrder.map(item => `
                <div class="order-item">
                    <span>${item.name}</span>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                    <span>Rs.${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('order-total').textContent = total.toFixed(2);
        }

        function updateQuantity(itemId, change) {
            const item = state.currentOrder.find(i => i.id === itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    state.currentOrder = state.currentOrder.filter(i => i.id !== itemId);
                }
                renderOrderSummary();
            }
        }

        async function submitOrder() {
            if (state.currentOrder.length === 0) {
                alert('Please add items to the order');
                return;
            }

            const table = state.tables.find(t => t.number === state.selectedTable);
            if (!table) {
                alert('Table not found');
                return;
            }

            table.status = 'occupied';
            table.orders = [...state.currentOrder];

            const kitchenOrder = {
                id: Date.now(),
                tableNumber: state.selectedTable,
                items: [...state.currentOrder],
                status: 'pending',
                timestamp: new Date().toLocaleTimeString()
            };

            state.kitchenOrders.push(kitchenOrder);

            await saveData('tables', { id: 'main', tables: state.tables });
            await saveData('kitchenOrders', { id: 'main', orders: state.kitchenOrders });

            state.currentOrder = [];
            state.selectedTable = null;
            
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('order-summary').style.display = 'none';

            alert('Order submitted to kitchen!');
            render();
        }

        function cancelOrder() {
            state.currentOrder = [];
            state.selectedTable = null;
            document.getElementById('menu-section').style.display = 'none';
            document.getElementById('order-summary').style.display = 'none';
            renderTables();
        }

        function renderKitchen() {
            const container = document.getElementById('kitchen-orders');
            if (!container) return;

            if (state.kitchenOrders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No pending orders</p>';
                return;
            }

            container.innerHTML = state.kitchenOrders.map(order => `
                <div class="kitchen-order ${order.status}">
                    <div class="kitchen-order-header">
                        Table ${order.tableNumber}
                        <br><small>${order.timestamp}</small>
                    </div>
                    ${order.items.map(item => `
                        <div class="kitchen-order-item">
                            <strong>${item.name}</strong> x${item.quantity}
                        </div>
                    `).join('')}
                    <button class="btn-submit" style="margin-top: 1rem;" onclick="markOrderReady(${order.id})">
                        ${order.status === 'pending' ? 'Mark Ready' : 'Ready ‚úì'}
                    </button>
                </div>
            `).join('');
        }

        async function markOrderReady(orderId) {
            const order = state.kitchenOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'ready';
                await saveData('kitchenOrders', { id: 'main', orders: state.kitchenOrders });
                renderKitchen();
            }
        }

        function renderCheckout() {
            const occupiedTables = state.tables.filter(t => t.status === 'occupied');
            const container = document.getElementById('checkout-tables');
            if (!container) return;

            if (occupiedTables.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No tables to checkout</p>';
                return;
            }

            container.innerHTML = occupiedTables.map(table => {
                const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                return `
                    <div class="checkout-table-card" onclick="selectCheckoutTable(${table.number})">
                        <h3>Table ${table.number}</h3>
                        <p>Items: ${table.orders.length}</p>
                        <p><strong>Total: Rs.${total.toFixed(2)}</strong></p>
                    </div>
                `;
            }).join('');
        }

        function selectCheckoutTable(tableNum) {
            state.selectedCheckoutTable = tableNum;
            const table = state.tables.find(t => t.number === tableNum);
            if (!table) return;

            const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            document.getElementById('checkout-table-num').textContent = tableNum;
            document.getElementById('checkout-items').innerHTML = table.orders.map(item => `
                <div class="order-item">
                    <span>${item.name} x${item.quantity}</span>
                    <span>Rs.${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('checkout-total').textContent = total.toFixed(2);
            document.getElementById('checkout-details').style.display = 'block';
            document.getElementById('checkout-tables').style.display = 'none';
        }

        function selectPayment(method) {
            state.paymentMethod = method;
            
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            document.getElementById('split-payment').style.display = method === 'Both' ? 'block' : 'none';
        }

        async function processPayment() {
            if (!state.paymentMethod) {
                alert('Please select a payment method');
                return;
            }

            const table = state.tables.find(t => t.number === state.selectedCheckoutTable);
            if (!table) {
                alert('Table not found');
                return;
            }

            const total = table.orders.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let cashAmount = 0;
            let qrAmount = 0;

            if (state.paymentMethod === 'Cash') {
                cashAmount = total;
            } else if (state.paymentMethod === 'QR') {
                qrAmount = total;
            } else {
                cashAmount = parseFloat(document.getElementById('cash-amount').value) || 0;
                qrAmount = parseFloat(document.getElementById('qr-amount').value) || 0;

                if (Math.abs(cashAmount + qrAmount - total) > 0.01) {
                    alert('Total payment must equal bill amount');
                    return;
                }
            }

            const transaction = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                timestamp: new Date().toLocaleTimeString(),
                tableNumber: state.selectedCheckoutTable,
                items: [...table.orders],
                total: total,
                paymentMethod: state.paymentMethod,
                cashAmount: cashAmount,
                qrAmount: qrAmount
            };

            state.completedTransactions.push(transaction);

            // Clear table
            table.status = 'vacant';
            table.orders = [];

            // Remove from kitchen orders
            state.kitchenOrders = state.kitchenOrders.filter(o => o.tableNumber !== state.selectedCheckoutTable);

            await saveData('tables', { id: 'main', tables: state.tables });
            await saveData('kitchenOrders', { id: 'main', orders: state.kitchenOrders });
            await saveData('transactions', { id: 'main', transactions: state.completedTransactions });

            alert('Payment processed successfully!');
            cancelCheckout();
            render();
        }

        function cancelCheckout() {
            state.selectedCheckoutTable = null;
            state.paymentMethod = '';
            const details = document.getElementById('checkout-details');
            const tables = document.getElementById('checkout-tables');
            if (details && tables) {
                details.style.display = 'none';
                tables.style.display = 'block';
            }
            document.getElementById('cash-amount').value = '';
            document.getElementById('qr-amount').value = '';
        }

        // Table Management
        function editTables() {
            const tableCount = prompt('Enter number of tables:', state.tableCount);
            if (tableCount && !isNaN(tableCount)) {
                const newCount = parseInt(tableCount);
                if (newCount > 0 && newCount <= 50) {
                    // Update tables
                    if (newCount > state.tables.length) {
                        // Add new tables
                        for (let i = state.tables.length + 1; i <= newCount; i++) {
                            state.tables.push({
                                id: i,
                                number: i,
                                status: 'vacant',
                                orders: []
                            });
                        }
                    } else if (newCount < state.tables.length) {
                        // Remove extra tables (keep first n tables)
                        state.tables = state.tables.slice(0, newCount);
                    }
                    
                    state.tableCount = newCount;
                    saveData('tables', { id: 'main', tables: state.tables });
                    saveData('config', { restaurantName: state.restaurantName, tableCount: state.tableCount });
                    renderTables();
                    alert(`Updated to ${newCount} tables`);
                }
            }
        }

        function addTable() {
            const tableNumber = prompt('Enter table number:');
            if (tableNumber && !isNaN(tableNumber)) {
                const num = parseInt(tableNumber);
                if (num > 0) {
                    // Check if table already exists
                    if (state.tables.some(t => t.number === num)) {
                        alert(`Table ${num} already exists`);
                        return;
                    }
                    
                    state.tables.push({
                        id: Date.now(),
                        number: num,
                        status: 'vacant',
                        orders: []
                    });
                    
                    // Sort tables by number
                    state.tables.sort((a, b) => a.number - b.number);
                    state.tableCount = state.tables.length;
                    
                    saveData('tables', { id: 'main', tables: state.tables });
                    saveData('config', { restaurantName: state.restaurantName, tableCount: state.tableCount });
                    renderTables();
                    alert(`Added Table ${num}`);
                }
            }
        }

        // Menu Management
        function editMenu() {
            const action = prompt('Menu Management:\n1. Add Item\n2. Edit Item\n3. Delete Item\n\nEnter choice (1-3):');
            
            switch(action) {
                case '1':
                    addMenuItem();
                    break;
                case '2':
                    editMenuItem();
                    break;
                case '3':
                    deleteMenuItem();
                    break;
            }
        }

        function addMenuItem() {
            const name = prompt('Enter item name:');
            if (!name) return;
            
            const price = prompt('Enter price:');
            if (!price || isNaN(price)) return;
            
            const category = prompt('Enter category (Main/Starter/Side/Drink/Dessert):', 'Main');
            
            state.menuItems.push({
                id: Date.now(),
                name: name,
                price: parseFloat(price),
                category: category
            });
            
            saveData('menuItems', { id: 'main', items: state.menuItems });
            alert(`Added ${name} to menu`);
            renderMenu();
        }

        function editMenuItem() {
            const itemList = state.menuItems.map((item, index) => `${index + 1}. ${item.name} - Rs.${item.price}`).join('\n');
            const choice = prompt(`Select item to edit:\n\n${itemList}\n\nEnter number:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < state.menuItems.length) {
                    const item = state.menuItems[index];
                    const newName = prompt('Enter new name:', item.name);
                    if (newName === null) return;
                    
                    const newPrice = prompt('Enter new price:', item.price);
                    if (newPrice === null || isNaN(newPrice)) return;
                    
                    const newCategory = prompt('Enter new category:', item.category);
                    if (newCategory === null) return;
                    
                    item.name = newName;
                    item.price = parseFloat(newPrice);
                    item.category = newCategory;
                    
                    saveData('menuItems', { id: 'main', items: state.menuItems });
                    alert('Item updated');
                    renderMenu();
                }
            }
        }

        function deleteMenuItem() {
            const itemList = state.menuItems.map((item, index) => `${index + 1}. ${item.name} - Rs.${item.price}`).join('\n');
            const choice = prompt(`Select item to delete:\n\n${itemList}\n\nEnter number:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < state.menuItems.length) {
                    const itemName = state.menuItems[index].name;
                    if (confirm(`Delete ${itemName}?`)) {
                        state.menuItems.splice(index, 1);
                        saveData('menuItems', { id: 'main', items: state.menuItems });
                        alert('Item deleted');
                        renderMenu();
                    }
                }
            }
        }

        // Expense Functions
        function showAddExpenseModal() {
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-expense-modal').classList.remove('hidden');
        }

        function hideAddExpenseModal() {
            document.getElementById('add-expense-modal').classList.add('hidden');
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
        }

        async function saveExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;

            if (!description || !amount || amount <= 0) {
                alert('Please enter valid expense details');
                return;
            }

            const expense = {
                id: Date.now(),
                description: description,
                amount: amount,
                category: category,
                date: date || new Date().toLocaleDateString(),
                timestamp: new Date().toLocaleTimeString()
            };

            state.expenses.push(expense);
            await saveData('expenses', { id: 'main', expenses: state.expenses });
            hideAddExpenseModal();
            renderExpenses();
            generateReports();
        }

        function renderExpenses() {
            const total = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalElement = document.getElementById('total-expenses');
            if (totalElement) {
                totalElement.textContent = total.toFixed(2);
            }

            const container = document.getElementById('expenses-list');
            if (!container) return;

            if (state.expenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No expenses recorded</p>';
                return;
            }

            container.innerHTML = state.expenses.slice().reverse().map(expense => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>${expense.description}</strong>
                        <strong style="color: #dc2626;">Rs.${expense.amount.toFixed(2)}</strong>
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        ${expense.category} ‚Ä¢ ${expense.date} ${expense.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // Reports Functions
        function generateReports() {
            const startDate = document.getElementById('report-start-date').value 
                ? new Date(document.getElementById('report-start-date').value)
                : new Date();
                
            const endDate = document.getElementById('report-end-date').value
                ? new Date(document.getElementById('report-end-date').value)
                : new Date();

            // Filter data by date range
            const filteredTransactions = state.completedTransactions.filter(t => {
                const transDate = new Date(t.date);
                return transDate >= startDate && transDate <= endDate;
            });

            const filteredExpenses = state.expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate >= startDate && expDate <= endDate;
            });

            // Calculate metrics
            const totalSales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const cashSales = filteredTransactions.filter(t => t.paymentMethod === 'Cash' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.cashAmount || t.total), 0);
            const digitalSales = filteredTransactions.filter(t => t.paymentMethod === 'QR' || t.paymentMethod === 'Both')
                .reduce((sum, t) => sum + (t.qrAmount || t.total), 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalSales - totalExpenses;
            const profitMargin = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
            const expensesPercentage = totalSales > 0 ? (totalExpenses / totalSales * 100).toFixed(1) : 0;

            // Update UI
            document.getElementById('total-sales').textContent = `Rs.${totalSales.toFixed(2)}`;
            document.getElementById('cash-sales').textContent = `Rs.${cashSales.toFixed(2)}`;
            document.getElementById('digital-sales').textContent = `Rs.${digitalSales.toFixed(2)}`;
            document.getElementById('total-orders').textContent = filteredTransactions.length;
            document.getElementById('avg-order-value').textContent = filteredTransactions.length > 0 
                ? `Rs.${(totalSales / filteredTransactions.length).toFixed(2)}` 
                : 'Rs.0.00';
            document.getElementById('tables-turned').textContent = new Set(filteredTransactions.map(t => t.tableNumber)).size;
            document.getElementById('total-expenses-report').textContent = `Rs.${totalExpenses.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `Rs.${netProfit.toFixed(2)}`;
            document.getElementById('profit-margin').textContent = `${profitMargin}%`;
            document.getElementById('expenses-percentage').textContent = `${expensesPercentage}%`;

            // Top items
            const itemSales = {};
            filteredTransactions.forEach(trans => {
                trans.items.forEach(item => {
                    if (!itemSales[item.name]) {
                        itemSales[item.name] = { quantity: 0, revenue: 0 };
                    }
                    itemSales[item.name].quantity += item.quantity;
                    itemSales[item.name].revenue += item.price * item.quantity;
                });
            });

            const topItems = Object.entries(itemSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);

            const topItemsList = document.getElementById('top-items-list');
            if (topItemsList) {
                topItemsList.innerHTML = topItems.map(([name, data], index) => `
                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                        <span>${index + 1}. ${name}</span>
                        <span>${data.quantity} sold (Rs.${data.revenue.toFixed(2)})</span>
                    </div>
                `).join('') || '<p style="color: #6b7280; text-align: center;">No sales data</p>';
            }
        }

        function setDateRange(range) {
            const today = new Date();
            let startDate, endDate = today;

            switch(range) {
                case 'today':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
            }

            document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('report-end-date').value = endDate.toISOString().split('T')[0];
            generateReports();
        }

        function exportSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'SALES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Table,Items,Total,Payment Method,Cash Amount,QR Amount\n';
            
            state.completedTransactions.forEach(t => {
                const transDate = new Date(t.date);
                if (transDate >= new Date(startDate) && transDate <= new Date(endDate)) {
                    const items = t.items.map(i => `${i.name}x${i.quantity}`).join('; ');
                    csv += `${t.date},${t.timestamp},${t.tableNumber},"${items}",${t.total},${t.paymentMethod},${t.cashAmount || 0},${t.qrAmount || 0}\n`;
                }
            });

            downloadCSV(csv, `sales-report-${startDate}-to-${endDate}.csv`);
        }

        function exportExpensesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let csv = 'EXPENSES REPORT\n';
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += 'Date,Time,Description,Amount,Category\n';
            
            state.expenses.forEach(e => {
                const expDate = new Date(e.date);
                if (expDate >= new Date(startDate) && expDate <= new Date(endDate)) {
                    csv += `${e.date},${e.timestamp},"${e.description}",${e.amount},${e.category}\n`;
                }
            });

            downloadCSV(csv, `expenses-report-${startDate}-to-${endDate}.csv`);
        }

        function exportMenuReport() {
            let csv = 'MENU REPORT\n';
            csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csv += 'Category,Item Name,Price\n';
            
            // Group by category
            const itemsByCategory = {};
            state.menuItems.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            Object.entries(itemsByCategory).forEach(([category, items]) => {
                items.forEach(item => {
                    csv += `${category},"${item.name}",${item.price}\n`;
                });
            });

            downloadCSV(csv, `menu-report-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Settings Functions
        function showSettings() {
            document.getElementById('settings-restaurant-name').value = state.restaurantName;
            document.getElementById('settings-table-count').value = state.tableCount;
            document.getElementById('firebase-status').textContent = syncEnabled ? 'Connected' : 'Local Only';
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function updateSettings() {
            const restaurantName = document.getElementById('settings-restaurant-name').value;
            const tableCount = parseInt(document.getElementById('settings-table-count').value);

            state.restaurantName = restaurantName;
            
            if (tableCount !== state.tableCount) {
                state.tableCount = tableCount;
                
                // Update tables
                if (tableCount > state.tables.length) {
                    // Add new tables
                    for (let i = state.tables.length + 1; i <= tableCount; i++) {
                        state.tables.push({
                            id: i,
                            number: i,
                            status: 'vacant',
                            orders: []
                        });
                    }
                } else if (tableCount < state.tables.length) {
                    // Remove extra tables
                    state.tables = state.tables.slice(0, tableCount);
                }
                
                await saveData('tables', { id: 'main', tables: state.tables });
            }

            await saveData('config', { restaurantName: state.restaurantName, tableCount: state.tableCount });
            hideSettingsModal();
            renderTables();
            alert('Settings updated!');
        }

        function resetData() {
            if (confirm('‚ö†Ô∏è Reset all data? This cannot be undone.')) {
                localStorage.clear();
                if (syncEnabled && db) {
                    // Note: In production, you'd want to properly clear Firebase
                    alert('Firebase data will need to be cleared from the console.');
                }
                location.reload();
            }
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            // Refresh data when switching tabs
            if (tab === 'waiter') {
                renderTables();
            } else if (tab === 'kitchen') {
                renderKitchen();
            } else if (tab === 'checkout') {
                renderCheckout();
            } else if (tab === 'expenses') {
                renderExpenses();
            } else if (tab === 'reports') {
                generateReports();
            }
        }

        // Start on load
        window.addEventListener('load', () => {
            // Set default date values
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
            
            // Check if Firebase modules are loaded (wait a bit)
            setTimeout(async () => {
                if (window.firebaseDb) {
                    console.log('Firebase loaded, proceeding with setup...');
                    // Check if we have existing data
                    try {
                        const config = localStorage.getItem('config');
                        const tables = localStorage.getItem('tables');
                        if (config || tables) {
                            // Skip setup if we have data
                            document.getElementById('setup-wizard').classList.add('hidden');
                            startApp();
                        }
                    } catch (error) {
                        console.log('No existing data found, showing setup wizard');
                    }
                } else {
                    console.log('Firebase not loaded, showing setup wizard');
                }
            }, 1000);
        });
    </script>
</body>
</html>