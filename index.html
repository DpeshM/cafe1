<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Restaurant POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: white;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Mobile Bottom Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            padding: 5px 0;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            color: #64748b;
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .mobile-nav-item.active {
            color: #3b82f6;
        }

        .mobile-nav-item .icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Tables Sidebar */
        .tables-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 15px;
            overflow-y: auto;
            transition: transform 0.3s;
        }

        .tables-sidebar h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.1rem;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .table-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .table-card:active {
            transform: scale(0.98);
        }

        .table-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .table-card.vacant {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .table-card.occupied {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .table-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1e293b;
            line-height: 1;
        }

        .table-status {
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .table-amount {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 4px;
            line-height: 1;
        }

        /* Menu Area */
        .menu-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .category-tab {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .category-tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .menu-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 120px;
        }

        .menu-item:active {
            transform: scale(0.98);
        }

        .menu-item h4 {
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 0.95rem;
            line-height: 1.2;
        }

        .menu-item-category {
            color: #64748b;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .menu-item-price {
            color: #10b981;
            font-weight: bold;
            font-size: 1rem;
        }

        .menu-item-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: 2px solid #3b82f6;
            background: white;
            border-radius: 6px;
            color: #3b82f6;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:active {
            background: #3b82f6;
            color: white;
        }

        .qty-display {
            min-width: 28px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
        }

        /* Order Panel */
        .order-panel {
            width: 350px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
        }

        .order-header {
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            position: sticky;
            top: 0;
        }

        .order-header h3 {
            font-size: 1.1rem;
        }

        .order-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .order-item-name {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .order-item-qty {
            margin: 0 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .order-item-price {
            color: #10b981;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 50px;
            text-align: right;
        }

        .order-footer {
            padding: 15px;
            border-top: 2px solid #e2e8f0;
            background: white;
            position: sticky;
            bottom: 0;
        }

        .order-total {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: #3b82f6;
        }

        .btn-primary:active {
            background: #2563eb;
            transform: scale(0.98);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:active {
            background: #059669;
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:active {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:active {
            background: #dc2626;
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            z-index: 999;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sync-status.online {
            color: #10b981;
        }

        .sync-status.offline {
            color: #ef4444;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 15px;
            left: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1100;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal h2 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .payment-method {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:active {
            transform: scale(0.98);
        }

        .payment-method.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Mobile Views */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                height: calc(100vh - 60px);
            }
            
            .tables-sidebar {
                width: 100%;
                height: auto;
                max-height: 150px;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                padding: 10px;
            }
            
            .tables-grid {
                display: flex;
                overflow-x: auto;
                gap: 6px;
                padding-bottom: 5px;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-card {
                min-width: 80px;
                min-height: 60px;
                padding: 8px;
            }
            
            .table-number {
                font-size: 1.1rem;
            }
            
            .table-status {
                font-size: 0.6rem;
            }
            
            .order-panel {
                position: fixed;
                bottom: 40px;
                left: 0;
                right: 0;
                width: 100%;
                height: 300px;
                transform: translateY(100%);
                border-left: none;
                border-top: 2px solid #e2e8f0;
                z-index: 900;
            }
            
            .order-panel.active {
                transform: translateY(0);
            }
            
            .menu-area {
                margin-bottom: 0;
                padding-bottom: 80px;
            }
            
            .mobile-nav {
                display: flex;
            }
            
            .header {
                padding: 10px 12px;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .menu-item {
                min-height: 100px;
                padding: 10px;
            }
            
            .menu-item h4 {
                font-size: 0.85rem;
            }
            
            .category-tabs {
                gap: 6px;
            }
            
            .category-tab {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .notification {
                left: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        /* Swipe to open order panel */
        .swipe-indicator {
            position: fixed;
            bottom: 40px;
            left: 0;
            right: 0;
            text-align: center;
            color: #64748b;
            font-size: 0.8rem;
            padding: 8px;
            background: linear-gradient(to top, rgba(248,250,252,0.9), transparent);
            z-index: 800;
            display: none;
        }

        @media (max-width: 1024px) {
            .swipe-indicator {
                display: block;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üçΩÔ∏è Restaurant POS</h1>
        <div class="header-buttons">
            <a href="kitchen.html" class="btn btn-outline">üë®‚Äçüç≥ Kitchen</a>
            <button class="btn btn-outline" onclick="toggleOrderPanel()" id="order-toggle">üìã Order</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tables Sidebar -->
        <div class="tables-sidebar">
            <h3>Tables</h3>
            <div class="tables-grid" id="tables-list">
                <div class="loading">Loading tables...</div>
            </div>
        </div>

        <!-- Menu Area -->
        <div class="menu-area">
            <div class="category-tabs" id="category-tabs">
                <div class="category-tab active" data-category="all">All</div>
            </div>
            <div class="menu-grid" id="menu-grid">
                <div class="loading">Loading menu...</div>
            </div>
        </div>

        <!-- Order Panel -->
        <div class="order-panel" id="order-panel">
            <div class="order-header">
                <h3 id="current-table-title">Select a Table</h3>
                <button class="btn btn-outline" onclick="toggleOrderPanel()" style="margin-top: 8px; padding: 4px 8px; font-size: 0.8rem;">
                    Close
                </button>
            </div>
            <div class="order-body" id="order-items">
                <div style="color: #64748b; text-align: center; padding: 40px 20px;">
                    No items added
                </div>
            </div>
            <div class="order-footer">
                <div class="order-total">
                    Total: <span id="order-total">$0.00</span>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="submitOrder()">Submit Order</button>
                    <button class="btn btn-success" onclick="showCheckoutModal()" id="checkout-btn" style="display: none;">Checkout</button>
                    <button class="btn btn-secondary" onclick="clearOrder()">Clear Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Swipe Indicator -->
    <div class="swipe-indicator">
        ‚Üë Swipe up to view order
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="#" class="mobile-nav-item active" onclick="showSection('tables')">
            <div class="icon">ü™ë</div>
            <div>Tables</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showSection('menu')">
            <div class="icon">üìã</div>
            <div>Menu</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="toggleOrderPanel()">
            <div class="icon">üõí</div>
            <div>Order</div>
        </a>
        <a href="kitchen.html" class="mobile-nav-item">
            <div class="icon">üë®‚Äçüç≥</div>
            <div>Kitchen</div>
        </a>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div id="sync-status" class="sync-status online">üü¢ Synced</div>
        <div id="last-update">Last update: Just now</div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkout-modal">
        <div class="modal">
            <h2>Checkout - Table <span id="checkout-table-number"></span></h2>
            <div id="checkout-items-list"></div>
            <div class="order-total" style="margin: 15px 0;">
                Total: <span id="checkout-total">$0.00</span>
            </div>
            
            <h4 style="margin-bottom: 10px;">Payment Method</h4>
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPayment('cash')">
                    <div style="font-size: 1.5rem;">üíµ</div>
                    <div>Cash</div>
                </div>
                <div class="payment-method" onclick="selectPayment('card')">
                    <div style="font-size: 1.5rem;">üí≥</div>
                    <div>Card</div>
                </div>
                <div class="payment-method" onclick="selectPayment('upi')">
                    <div style="font-size: 1.5rem;">üì±</div>
                    <div>UPI</div>
                </div>
                <div class="payment-method" onclick="selectPayment('split')">
                    <div style="font-size: 1.5rem;">‚ÜîÔ∏è</div>
                    <div>Split</div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 15px;">
                <button class="btn btn-success" onclick="processCheckout()">Complete Payment</button>
                <button class="btn btn-secondary" onclick="hideModal('checkout-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notification-container"></div>

    <script>
        // ==================== CONFIGURATION ====================
        const APP_NAME = 'RestaurantPOS';
        const STORAGE_KEYS = {
            SERVER: APP_NAME + '_server_data',
            DEVICE: APPName + '_device_id'
        };
        
        const SYNC_INTERVAL = 2000; // 2 seconds
        let syncInterval;

        // ==================== STATE MANAGEMENT ====================
        const state = {
            deviceId: '',
            serverData: null,
            currentTable: null,
            currentOrder: [],
            selectedPayment: null,
            lastSync: null
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupTouchEvents();
        });

        function initializeApp() {
            // Generate or get device ID
            state.deviceId = getDeviceId();
            
            // Load initial data
            loadData();
            
            // Start sync loop
            startSyncLoop();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initial render
            renderAll();
        }

        function getDeviceId() {
            let deviceId = localStorage.getItem(STORAGE_KEYS.DEVICE);
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(STORAGE_KEYS.DEVICE, deviceId);
            }
            return deviceId;
        }

        // ==================== DATA MANAGEMENT ====================
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEYS.SERVER);
            
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    
                    // Merge with existing state to preserve current session
                    if (state.serverData) {
                        // Preserve current order if we have a selected table
                        if (state.currentTable && state.currentOrder.length > 0) {
                            const tableIndex = parsed.tables.findIndex(t => t.id === state.currentTable);
                            if (tableIndex !== -1) {
                                parsed.tables[tableIndex].currentOrder = [...state.currentOrder];
                            }
                        }
                    }
                    
                    state.serverData = parsed;
                    state.lastSync = new Date().toISOString();
                    
                } catch (e) {
                    console.error('Error loading data:', e);
                    createDemoData();
                }
            } else {
                createDemoData();
            }
        }

        function createDemoData() {
            state.serverData = {
                tables: [],
                menu: [],
                orders: [],
                transactions: [],
                lastUpdate: new Date().toISOString()
            };

            // Create demo tables (1-8)
            for (let i = 1; i <= 8; i++) {
                state.serverData.tables.push({
                    id: `table_${i}`,
                    number: i,
                    name: `Table ${i}`,
                    capacity: i <= 2 ? 2 : i <= 5 ? 4 : 6,
                    status: 'vacant',
                    currentOrder: [],
                    lastUpdate: new Date().toISOString()
                });
            }

            // Create demo menu
            state.serverData.menu = [
                { id: 'item_1', name: 'Burger', category: 'Main', price: 8.99, stock: 50 },
                { id: 'item_2', name: 'Pizza', category: 'Main', price: 12.99, stock: 50 },
                { id: 'item_3', name: 'Fries', category: 'Side', price: 4.99, stock: 50 },
                { id: 'item_4', name: 'Salad', category: 'Side', price: 6.99, stock: 50 },
                { id: 'item_5', name: 'Coke', category: 'Drink', price: 1.99, stock: 50 },
                { id: 'item_6', name: 'Water', category: 'Drink', price: 0.99, stock: 50 },
                { id: 'item_7', name: 'Ice Cream', category: 'Dessert', price: 4.99, stock: 50 },
                { id: 'item_8', name: 'Coffee', category: 'Drink', price: 2.49, stock: 50 }
            ];

            // Set current order from demo table if needed
            if (state.currentTable) {
                const table = state.serverData.tables.find(t => t.id === state.currentTable);
                if (table) {
                    state.currentOrder = table.currentOrder || [];
                }
            }

            saveData();
        }

        function saveData() {
            if (!state.serverData) return;
            
            // Update timestamp
            state.serverData.lastUpdate = new Date().toISOString();
            
            // Save to localStorage
            localStorage.setItem(STORAGE_KEYS.SERVER, JSON.stringify(state.serverData));
            
            // Trigger sync for other tabs
            window.dispatchEvent(new StorageEvent('storage', {
                key: STORAGE_KEYS.SERVER,
                newValue: JSON.stringify(state.serverData)
            }));
            
            updateSyncStatus();
        }

        // ==================== SYNC SYSTEM ====================
        function startSyncLoop() {
            // Clear any existing interval
            if (syncInterval) clearInterval(syncInterval);
            
            // Check for updates every SYNC_INTERVAL
            syncInterval = setInterval(() => {
                loadData();
                renderAll();
            }, SYNC_INTERVAL);
        }

        function setupEventListeners() {
            // Listen for updates from other tabs
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEYS.SERVER) {
                    const oldData = JSON.stringify(state.serverData);
                    loadData();
                    
                    // Only update UI if data changed
                    if (oldData !== JSON.stringify(state.serverData)) {
                        renderAll();
                        showNotification('Data updated', 'info');
                    }
                }
            });

            // Online/offline status
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);

            // Prevent pull-to-refresh on mobile
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderAll() {
            renderTables();
            renderMenu();
            renderCategories();
            updateOrderPanel();
            updateSyncStatus();
        }

        function renderTables() {
            const container = document.getElementById('tables-list');
            if (!container || !state.serverData) return;
            
            const tables = state.serverData.tables || [];
            
            container.innerHTML = tables.map(table => {
                const orderTotal = (table.currentOrder || []).reduce((sum, item) => 
                    sum + (item.price * item.quantity), 0);
                
                return `
                    <div class="table-card ${table.status} ${state.currentTable === table.id ? 'active' : ''}" 
                         onclick="selectTable('${table.id}')">
                        <div class="table-number">${table.number}</div>
                        <div class="table-status">${table.status}</div>
                        ${orderTotal > 0 ? 
                            `<div class="table-amount">$${orderTotal.toFixed(2)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderCategories() {
            const container = document.getElementById('category-tabs');
            if (!container || !state.serverData) return;
            
            const categories = ['all', ...new Set(state.serverData.menu.map(item => item.category))];
            
            container.innerHTML = categories.map(category => `
                <div class="category-tab ${category === 'all' ? 'active' : ''}" 
                     onclick="filterMenu('${category}')">
                    ${category === 'all' ? 'All' : category}
                </div>
            `).join('');
        }

        function renderMenu(filter = 'all') {
            const container = document.getElementById('menu-grid');
            if (!container || !state.serverData) return;
            
            let items = state.serverData.menu || [];
            if (filter !== 'all') {
                items = items.filter(item => item.category === filter);
            }
            
            container.innerHTML = items.map(item => {
                const currentQty = getOrderQuantity(item.id);
                return `
                    <div class="menu-item" onclick="quickAdd('${item.id}')">
                        <h4>${item.name}</h4>
                        <div class="menu-item-category">${item.category}</div>
                        <div class="menu-item-price">$${item.price.toFixed(2)}</div>
                        <div class="menu-item-controls">
                            <button class="qty-btn" onclick="adjustQuantity('${item.id}', -1, event)">-</button>
                            <div class="qty-display">${currentQty}</div>
                            <button class="qty-btn" onclick="adjustQuantity('${item.id}', 1, event)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterMenu(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter menu
            renderMenu(category);
        }

        function updateOrderPanel() {
            const itemsContainer = document.getElementById('order-items');
            const totalElement = document.getElementById('order-total');
            const tableTitle = document.getElementById('current-table-title');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (state.currentTable && state.serverData) {
                const table = state.serverData.tables.find(t => t.id === state.currentTable);
                if (table) {
                    tableTitle.textContent = `Table ${table.number}`;
                    checkoutBtn.style.display = table.status === 'occupied' ? 'block' : 'none';
                }
            } else {
                tableTitle.textContent = 'Select a Table';
                checkoutBtn.style.display = 'none';
            }

            if (state.currentOrder.length === 0) {
                itemsContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 40px 20px;">No items added</div>';
                totalElement.textContent = '$0.00';
                return;
            }

            itemsContainer.innerHTML = state.currentOrder.map(item => `
                <div class="order-item">
                    <div class="order-item-name">${item.name}</div>
                    <div class="order-item-qty">x${item.quantity}</div>
                    <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');

            const total = state.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        // ==================== ORDER MANAGEMENT ====================
        function selectTable(tableId) {
            if (!state.serverData) return;
            
            const table = state.serverData.tables.find(t => t.id === tableId);
            if (!table) return;
            
            state.currentTable = tableId;
            state.currentOrder = table.currentOrder || [];
            
            // Open order panel on mobile
            if (window.innerWidth <= 1024) {
                toggleOrderPanel();
            }
            
            renderTables();
            updateOrderPanel();
            renderMenu();
        }

        function quickAdd(itemId) {
            if (!state.currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            adjustQuantity(itemId, 1);
        }

        function adjustQuantity(itemId, change, event = null) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!state.currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }

            if (!state.serverData) return;
            
            const menuItem = state.serverData.menu.find(item => item.id === itemId);
            if (!menuItem) return;

            let orderItem = state.currentOrder.find(item => item.id === itemId);

            if (orderItem) {
                orderItem.quantity += change;
                if (orderItem.quantity <= 0) {
                    state.currentOrder = state.currentOrder.filter(item => item.id !== itemId);
                }
            } else if (change > 0) {
                state.currentOrder.push({
                    id: itemId,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1
                });
            }

            // Update table in server data
            if (state.serverData && state.currentTable) {
                const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
                if (tableIndex !== -1) {
                    state.serverData.tables[tableIndex].currentOrder = [...state.currentOrder];
                }
            }

            updateOrderPanel();
            renderMenu();
        }

        function getOrderQuantity(itemId) {
            const item = state.currentOrder.find(item => item.id === itemId);
            return item ? item.quantity : 0;
        }

        function submitOrder() {
            if (!state.currentTable || !state.serverData) {
                showNotification('Please select a table', 'error');
                return;
            }

            if (state.currentOrder.length === 0) {
                showNotification('Please add items to order', 'error');
                return;
            }

            const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
            if (tableIndex === -1) return;

            // Update table
            state.serverData.tables[tableIndex].status = 'occupied';
            state.serverData.tables[tableIndex].currentOrder = [...state.currentOrder];
            state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();

            // Create kitchen order
            const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            state.serverData.orders.push({
                id: orderId,
                tableId: state.currentTable,
                tableNumber: state.serverData.tables[tableIndex].number,
                items: [...state.currentOrder],
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: state.deviceId
            });

            // Save data
            saveData();
            
            // Clear current order
            state.currentOrder = [];
            
            // Update UI
            renderTables();
            updateOrderPanel();
            renderMenu();
            
            // Show success message
            showNotification('Order sent to kitchen!', 'success');
            
            // Vibrate on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        // ==================== CHECKOUT SYSTEM ====================
        function showCheckoutModal() {
            if (!state.currentTable || !state.serverData) return;
            
            const table = state.serverData.tables.find(t => t.id === state.currentTable);
            if (!table || table.status !== 'occupied') return;
            
            const items = table.currentOrder || [];
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('checkout-table-number').textContent = table.number;
            document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
            
            const itemsList = document.getElementById('checkout-items-list');
            itemsList.innerHTML = items.map(item => `
                <div class="order-item">
                    <div class="order-item-name">${item.name}</div>
                    <div class="order-item-qty">x${item.quantity}</div>
                    <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');
            
            showModal('checkout-modal');
        }

        function selectPayment(method) {
            state.selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
            event.target.closest('.payment-method').classList.add('active');
        }

        function processCheckout() {
            if (!state.selectedPayment || !state.currentTable || !state.serverData) {
                showNotification('Please select payment method', 'error');
                return;
            }

            const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
            if (tableIndex === -1) return;
            
            const table = state.serverData.tables[tableIndex];
            const items = table.currentOrder || [];
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Create transaction
            state.serverData.transactions.push({
                id: `txn_${Date.now()}`,
                tableId: state.currentTable,
                tableNumber: table.number,
                items: items,
                total: total,
                paymentMethod: state.selectedPayment,
                status: 'completed',
                timestamp: new Date().toISOString(),
                processedBy: state.deviceId
            });
            
            // Update table
            state.serverData.tables[tableIndex].status = 'vacant';
            state.serverData.tables[tableIndex].currentOrder = [];
            state.serverData.tables[tableIndex].lastUpdate = new Date().toISOString();
            
            // Remove kitchen orders for this table
            state.serverData.orders = state.serverData.orders.filter(order => 
                order.tableId !== state.currentTable || order.status === 'completed'
            );
            
            // Save data
            saveData();
            
            // Reset UI
            state.currentOrder = [];
            state.selectedPayment = null;
            hideModal('checkout-modal');
            updateOrderPanel();
            renderTables();
            
            // Show success
            showNotification(`Payment of $${total.toFixed(2)} completed!`, 'success');
            
            // Vibrate on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate([50, 30, 50]);
            }
        }

        function clearOrder() {
            if (state.currentOrder.length === 0) return;
            
            if (!confirm('Clear current order?')) return;
            
            state.currentOrder = [];
            
            // Update table in server data
            if (state.serverData && state.currentTable) {
                const tableIndex = state.serverData.tables.findIndex(t => t.id === state.currentTable);
                if (tableIndex !== -1) {
                    state.serverData.tables[tableIndex].currentOrder = [];
                }
            }
            
            updateOrderPanel();
            renderMenu();
            showNotification('Order cleared', 'info');
        }

        // ==================== MOBILE UI FUNCTIONS ====================
        function toggleOrderPanel() {
            const panel = document.getElementById('order-panel');
            const toggleBtn = document.getElementById('order-toggle');
            
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                toggleBtn.textContent = 'üìã Close';
                // Update order items when opening
                updateOrderPanel();
            } else {
                toggleBtn.textContent = 'üìã Order';
            }
        }

        function showSection(section) {
            // Update active nav item
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.mobile-nav-item').classList.add('active');
            
            // Scroll to appropriate section
            if (section === 'tables') {
                document.querySelector('.tables-sidebar').scrollIntoView({ behavior: 'smooth' });
            } else if (section === 'menu') {
                document.querySelector('.menu-area').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function setupTouchEvents() {
            let startY;
            const panel = document.getElementById('order-panel');
            
            // Swipe up to open order panel
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (!startY) return;
                
                const currentY = e.touches[0].clientY;
                const diff = startY - currentY;
                
                // Swipe up from bottom
                if (diff > 50 && window.innerHeight - startY < 100) {
                    panel.classList.add('active');
                }
                
                // Swipe down to close
                if (diff < -50 && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            }, { passive: true });
            
            document.addEventListener('touchend', () => {
                startY = null;
            }, { passive: true });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Restore body scroll
            document.body.style.overflow = '';
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateSyncStatus() {
            const statusEl = document.getElementById('sync-status');
            const updateEl = document.getElementById('last-update');
            
            if (navigator.onLine) {
                statusEl.className = 'sync-status online';
                statusEl.textContent = 'üü¢ Online';
            } else {
                statusEl.className = 'sync-status offline';
                statusEl.textContent = 'üî¥ Offline';
            }
            
            if (state.lastSync) {
                const date = new Date(state.lastSync);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 5) {
                    updateEl.textContent = 'Last update: Just now';
                } else if (diff < 60) {
                    updateEl.textContent = `Last update: ${diff} sec ago`;
                } else {
                    updateEl.textContent = `Last update: ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
            }
        }

        // ==================== PWA SUPPORT ====================
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after delay
            setTimeout(() => {
                if (deferredPrompt && confirm('Install this app for better experience?')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => {
                        deferredPrompt = null;
                    });
                }
            }, 10000);
        });

        // Prevent accidental refresh
        window.addEventListener('beforeunload', (e) => {
            if (state.currentOrder.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have an active order. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
